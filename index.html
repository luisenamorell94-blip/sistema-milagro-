<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Sistema Milagro | v49 Auto-Fix</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2c3e50">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ESTILOS DE SIEMPRE (PERFECTOS) */
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #27ae60; --blue: #2980b9; --money: #117a65; --bank: #8e44ad; --alert: #c0392b; --route: #e67e22; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; margin: 0; padding: 10px; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 900px; margin: 0 auto; }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .login-box { background: white; padding: 40px 30px; border-radius: 15px; width: 90%; max-width: 340px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        .cm-logo { font-size: 3em; font-weight: 900; color: var(--primary); border: 4px solid var(--primary); padding: 10px; border-radius: 10px; display: inline-block; margin-bottom: 20px; letter-spacing: -2px; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 16px; text-align: center; color: #333; background: #f9f9f9; }
        .login-btn { background: var(--blue); color: white; border: none; padding: 15px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 20px; transition: background 0.3s; }
        
        header { background: linear-gradient(135deg, #1a252f 0%, #2c3e50 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        /* TABS */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #e0e0e0; border-radius: 5px; font-weight: bold; cursor: pointer; white-space: nowrap; color: #555; }
        .tab-btn.active { background: var(--blue); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* RUTA (COBROS) */
        .ruta-header-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .ruta-counter { background: var(--route); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; }
        .ruta-list { max-height: 60vh; overflow-y: auto; border: 1px solid #eee; border-radius: 5px; background: #f9f9f9; }
        .ruta-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .ruta-info h4 { margin: 0; font-size: 1.1em; color: #333; }
        .ruta-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75em; font-weight: bold; display: inline-block; margin-top: 5px; }
        .bg-ok { background: #d5f5e3; color: #27ae60; }
        .bg-late { background: #fadbd8; color: #c0392b; }
        .bg-wait { background: #fcf3cf; color: #f39c12; }
        .btn-pay { background: var(--blue); color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* LIQUIDACION */
        .item-container { border: 1px solid #eee; background: #fafafa; padding: 8px; margin-bottom: 8px; border-radius: 6px; }
        .dynamic-row { display: flex; gap: 5px; margin-bottom: 5px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9em; }
        .lbl-small { font-size: 0.7em; color: #666; display: block; margin-bottom: 2px; }
        .btn-add { width: 100%; padding: 10px; background: #ecf0f1; border: 1px dashed #bdc3c7; cursor: pointer; margin-top: 5px; font-weight: bold; }
        .btn-del { background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 5px 15px; font-weight: bold; cursor: pointer; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 15px; width: 100%; border-radius: 6px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
        .btn-clear { background: #7f8c8d; color: white; border: none; padding: 15px; width: 100%; border-radius: 6px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
        .btn-danger { background: var(--alert); color: white; border: none; padding: 15px; width: 100%; border-radius: 6px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; animation: pulse 1.5s infinite; }
        .btn-del-row { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8em; }
        .btn-remove-pdf { background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-weight: bold; font-size: 10px; margin-left: 5px; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); box-shadow: 0 0 10px rgba(192, 57, 43, 0.5); } 100% { transform: scale(1); } }

        .money-card { border-left: 5px solid var(--money); background: #f4fbf9; }
        .money-result { font-size: 1.8em; font-weight: bold; color: var(--money); display:block; text-align:right; }
        .row-det { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95em; border-bottom: 1px dotted #eee; padding-bottom: 2px; }
        .efficiency-bar { height: 10px; background: #eee; border-radius: 5px; margin-top: 5px; overflow: hidden; }
        .efficiency-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s; }
        .efficiency-text { text-align: center; font-weight: bold; font-size: 0.9em; margin-top: 5px; color: #333; }

        .gallery { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
        .thumb { width: 70px; height: 70px; background: #eee; border-radius: 5px; position: relative; overflow: hidden; border: 1px solid #ccc; }
        .thumb img { width: 100%; height: 100%; object-fit: cover; }
        .thumb-x { position: absolute; top: 0; right: 0; background: rgba(255,0,0,0.8); color: white; border: none; width: 20px; height: 20px; cursor: pointer; font-weight: bold; }
        .btn-cam { background: var(--blue); color: white; padding: 10px; border: none; border-radius: 5px; width: 100%; cursor: pointer; margin-top: 5px; font-weight: bold; }
        
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .chart-box { background: white; padding: 10px; border-radius: 8px; border: 1px solid #eee; height: 220px; display: flex; justify-content: center; align-items: center; position: relative; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.85em; margin-top: 10px; }
        .data-table th { background: #ecf0f1; padding: 8px; text-align: left; border-bottom: 2px solid #bdc3c7; }
        .data-table td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; }

        .zones-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin: 10px 0; text-align: left; max-height: 150px; overflow-y: auto; background: #fff; border: 1px solid #ddd; padding: 5px; }
        .zone-check { display: flex; align-items: center; font-size: 0.85em; padding: 5px; border-bottom: 1px solid #eee; }
        .user-item { display: flex; justify-content: space-between; background: #fff; padding: 10px; border-bottom: 1px solid #eee; align-items: center; }

        .modal-overlay { display: none; position: fixed; z-index: 20000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 20px; width: 90%; max-width: 500px; border-radius: 10px; position: relative; box-shadow: 0 5px 25px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }
        .modal-header { font-weight: bold; font-size: 1.2em; margin-bottom: 15px; color: #2c3e50; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .modal-counter { font-size: 2.5em; font-weight: bold; text-align: center; margin: 10px 0; display: block; color: #c0392b; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 30000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #restore-msg { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: #2ecc71; color: white; padding: 10px 20px; border-radius: 30px; font-weight: bold; z-index: 9001; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

        /* IMPRESI√ìN */
        #seccion-impresion { display: none; }
        @media print {
            body { background: white; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; color: #333; }
            .container, #login-screen, #printControls, .modal-overlay, .btn-remove-pdf, #loading-overlay, #restore-msg { display: none !important; }
            #seccion-impresion { display: block !important; padding: 20px; box-sizing: border-box; }
            
            .pdf-header { display: flex; justify-content: space-between; border-bottom: 3px solid #2c3e50; margin-bottom: 10px; padding-bottom: 5px; }
            .pdf-header h1 { margin: 0; font-size: 22px; text-transform: uppercase; color: #2c3e50; }
            .pdf-title { background: #eee; font-weight: bold; padding: 3px; border-bottom: 1px solid #000; font-size: 11px; margin: 10px 0 3px 0; text-align: center; text-transform: uppercase; }
            .pdf-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 5px; }
            .pdf-table th, .pdf-table td { border-bottom: 1px dotted #ccc; padding: 3px; text-align: left; }
            
            .pdf-summary-container { width: 100%; max-width: 400px; margin-left: auto; margin-top: 10px; border: 2px solid #333; padding: 10px; background: #fdfdfd; page-break-inside: avoid; }
            .pdf-sum-row { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 12px; }
            .pdf-sum-row.plus { color: #27ae60; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 3px; }
            .pdf-sum-row.minus { color: #c0392b; }
            .pdf-neto-box { border-top: 3px double #333; margin-top: 5px; padding-top: 5px; font-size: 16px; font-weight: bold; color: #2c3e50; text-align: right; background: #eaf2f8; padding: 5px; }
            .pdf-pressure-box { border: 2px solid #2c3e50; background: #f4f6f7; padding: 5px; margin-top: 10px; text-align: center; font-size: 12px; page-break-inside: avoid; }
            .pdf-inv-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; background: #f4f6f7; padding: 5px; border: 1px solid #ddd; font-size: 10px; text-align: center; margin-top: 10px; page-break-inside: avoid; }
            .pdf-inv-item b { display: block; font-size: 12px; margin-bottom: 2px; }
            
            .pdf-compact-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; font-size: 10px; border: 1px solid #ccc; padding: 5px; background: #fff; page-break-inside: avoid; }
            .baja-item-pdf { border: 1px solid #eee; padding: 3px; text-align: center; background: #fafafa; }
            .baja-item-pdf strong { color: #333; font-size: 11px; }
            
            .pdf-evidence-section { page-break-before: always; margin-top: 20px; display: block; }
            .pdf-evidence-block { width: 100%; height: 45vh; border: 2px solid #333; margin-bottom: 10px; padding: 5px; box-sizing: border-box; page-break-inside: avoid; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
            .pdf-evidence-label { width: 100%; text-align: center; font-weight: bold; font-size: 14px; background: #eee; border-bottom: 2px solid #333; margin-bottom: 5px; padding: 2px 0; text-transform: uppercase; }
            .pdf-image-container { flex: 1; width: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; }
            .pdf-image-container img { max-width: 99%; max-height: 98%; object-fit: contain; }

            .pdf-signatures { display: flex; justify-content: space-between; margin-top: 30px; padding: 0 40px; page-break-inside: avoid; }
            .sign-line { border-top: 1px solid black; width: 40%; text-align: center; font-size: 12px; padding-top: 5px; }
        }
    </style>
</head>
<body>

<div id="loading-overlay"><div class="spinner"></div><h3 style="margin-top:20px;">Actualizando Sistema...</h3></div>
<div id="restore-msg">‚úÖ Datos Recuperados</div>

<div id="login-screen">
    <div class="login-box">
        <div class="cm-logo">CM</div>
        <h3 style="margin-top:0; color:#333;">COMERCIAL MILAGRO</h3>
        <input type="text" id="loginUser" placeholder="Usuario">
        <input type="password" id="loginPass" placeholder="Contrase√±a">
        <button class="login-btn" onclick="iniciarSesion()">ENTRAR AL SISTEMA</button>
        <p id="loginMsg" style="color:#c0392b; display:none; margin-top:10px; font-weight:bold;"></p>
    </div>
</div>

<div id="printControls" style="display:none; position:fixed; top:0; left:0; width:100%; background:#2c3e50; padding:15px; justify-content:space-around; z-index:10000; box-shadow:0 4px 10px rgba(0,0,0,0.3);">
    <button onclick="cerrarVistaPrevia()" style="padding:10px 20px; border-radius:20px; font-weight:bold; border:none; background:#e74c3c; color:white;">‚ùå VOLVER</button>
    <button onclick="window.print()" style="padding:10px 20px; border-radius:20px; font-weight:bold; border:none; background:#2ecc71; color:white;">üñ®Ô∏è IMPRIMIR</button>
</div>

<div id="abonoModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" onclick="closeAbono()">√ó</span>
        <div class="modal-header">üí∞ REGISTRAR ABONO</div>
        <div id="abono-info" style="text-align:center; font-weight:bold; margin-bottom:15px; font-size:1.2em;"></div>
        <input type="text" id="abono-recibo" placeholder="N¬∞ Recibo (Ej: 1540)" style="margin-bottom:10px; font-size:1.2em; text-align:center;">
        <input type="number" id="abono-monto" placeholder="Monto (L.)" style="margin-bottom:10px; font-size:1.2em; text-align:center;">
        <button class="btn-main" onclick="confirmarAbono()" style="background:var(--money);">CONFIRMAR PAGO</button>
    </div>
</div>

<div id="conciliacionModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" onclick="closeConciliacion()">√ó</span>
        <div class="modal-header">‚ö†Ô∏è BAJA DE TARJETAS</div>
        <p style="text-align:center;">Busca y elimina la tarjeta de la base.</p>
        <div style="background:#f9f9f9; padding:10px; border-radius:10px; text-align:center;">
            <small>Faltan por eliminar:</small>
            <span class="modal-counter" id="cards-to-delete-count">0</span>
        </div>
        <div style="margin-top:15px;">
            <input type="text" id="modal-search" placeholder="Buscar Clave o N√∫mero..." onkeyup="searchForDeletion()" style="font-size:1.2em; text-align:center; margin-bottom:10px;">
            <div style="max-height:250px; overflow-y:scroll; border:1px solid #eee;">
                <table class="data-table"><thead><tr><th>Clave</th><th>#</th><th>Acci√≥n</th></tr></thead><tbody id="modal-table-body"></tbody></table>
            </div>
        </div>
    </div>
</div>

<div id="historyModal" class="modal-overlay">
    <div class="modal-content" style="max-width:700px;">
        <span class="close-modal" onclick="closeHistory()">√ó</span>
        <div class="modal-header">üìú HISTORIAL DE MOVIMIENTOS</div>
        <div style="max-height:400px; overflow-y:scroll;">
            <table class="data-table">
                <thead><tr><th>Fecha</th><th>Tarjeta</th><th>Acci√≥n</th><th>Usuario</th></tr></thead>
                <tbody id="history-table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="container" id="app-container" style="display:none;">
    <header>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="font-size: 1.8em;">üè¶</div>
            <div><h2 style="margin:0; font-size:1.1em;">COMERCIAL MILAGRO</h2><small id="user-display"></small></div>
        </div>
        <button onclick="logout()" style="background:transparent; border:1px solid white; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;">Cerrar</button>
    </header>

    <div class="card" style="background:#fff3cd; border:1px solid #ffeeba; padding:10px;">
        <label style="font-weight:bold; font-size:0.8em; color:#856404;">ZONA DE TRABAJO</label>
        <select id="zonaSelect" style="margin-top:5px; font-weight:bold; width:100%;"></select>
    </div>

    <div class="tabs" id="tabs-admin">
        <button class="tab-btn active" onclick="nav('cuadre')">üìù Liquidaci√≥n</button>
        <button class="tab-btn" onclick="nav('ruta')" style="color:var(--route);">üöö COBROS</button>
        <button class="tab-btn" onclick="nav('stats')">üìä Estad√≠sticas</button>
        <button class="tab-btn" onclick="nav('usuarios')">üë• Usuarios</button>
        <button class="tab-btn" onclick="nav('base')">üóÉÔ∏è Base Datos</button>
    </div>
    <div class="tabs" id="tabs-cobrador" style="display:none;">
        <button class="tab-btn active" style="background:var(--accent); color:white;">üìà Mi Rendimiento</button>
    </div>

    <div id="view-cuadre" class="view-section active">
        <div class="card" style="text-align:center;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div><label class="lbl-small">FECHA CORTE</label><input type="date" id="fecha_liquidacion" style="font-weight:bold; text-align:center;"></div>
                <div><label class="lbl-small">PERIODO / SEMANA</label><input type="text" id="txt_semana" placeholder="Ej: SEMANA 1 ENERO" style="font-weight:bold; text-align:center;"></div>
            </div>
        </div>

        <div class="card money-card">
            <h3 style="margin:0 0 10px 0; color:var(--money);">1. Ingresos</h3>
            <div id="lista-talonarios"></div>
            <button class="btn-add" onclick="addTal()">+ Agregar Talonario</button>
            <div style="text-align:right; font-weight:bold; margin-top:10px; font-size:1.1em; color:var(--money);">Total Recaudado: <span id="lbl_tal">L. 0.00</span></div>
        </div>

        <div class="card" style="border-left: 5px solid #c0392b;">
            <h3 style="margin:0 0 10px 0; color:#c0392b;">2. Deducciones</h3>
            <label style="font-weight:bold; font-size:0.9em;">A. Gastos Operativos</label>
            <div id="lista-gastos"></div>
            <button class="btn-add" onclick="addGas()">+ Gasto</button>
            <div style="margin-top:5px;"><input type="file" id="in-gas-pic" accept="image/*" multiple hidden onchange="procPic(this, 'gal-gas')"><button class="btn-cam" onclick="document.getElementById('in-gas-pic').click()">üì∑ FOTOS GASTOS</button><div id="gal-gas" class="gallery"></div></div>
            <div style="text-align:right; font-weight:bold; margin:5px 0 15px 0; color:#c0392b;">Subtotal Gastos: <span id="lbl_gas">L. 0.00</span></div>
            <hr style="border:0; border-top:1px dashed #ccc; margin:10px 0;">
            <label style="font-weight:bold; font-size:0.9em; color:var(--bank);">B. Dep√≥sitos Banco</label>
            <div id="lista-banco"></div>
            <button class="btn-add" onclick="addBan()">+ Voucher</button>
            <div style="margin-top:5px;"><input type="file" id="in-ban-pic" accept="image/*" multiple hidden onchange="procPic(this, 'gal-ban')"><button class="btn-cam" onclick="document.getElementById('in-ban-pic').click()" style="background:var(--bank);">üì∑ FOTOS BANCO</button><div id="gal-ban" class="gallery"></div></div>
            <div style="text-align:right; font-weight:bold; margin-top:5px; color:var(--bank);">Subtotal Banco: <span id="lbl_ban">L. 0.00</span></div>
        </div>

        <div class="card">
            <h3 style="margin:0 0 10px 0;">3. Resumen Final</h3>
            <div style="background:#f9f9f9; padding:15px; border-radius:5px;">
                <div class="row-det"><span>(+) Recaudado:</span><span id="res_ing">L. 0.00</span></div>
                <div class="row-det"><span>(-) Comisi√≥n (10%):</span><span id="res_com" style="color:var(--alert);">L. 0.00</span></div>
                <div class="row-det"><span>(-) Total Gastos:</span><span id="res_gas" style="color:var(--alert);">L. 0.00</span></div>
                <div class="row-det"><span>(-) Total Banco:</span><span id="res_ban" style="color:var(--bank);">L. 0.00</span></div>
                <div style="border-top:2px dashed #333; margin-top:10px; padding-top:10px;"><span style="font-size:0.9em; font-weight:bold;">EFECTIVO NETO A ENTREGAR:</span><span id="res_neto" class="money-result">L. 0.00</span></div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin:0 0 10px 0; color:var(--primary);">üì¶ Inventario Tarjetas</h3>
            <div style="text-align:center; margin-bottom:5px;">Sistema: <strong id="total-sys">0</strong></div>
            <div class="dynamic-row">
                <div><span class="lbl-small" style="color:green;">(+)Nuevas</span><input type="number" id="inv-new" placeholder="0"></div>
                <div><span class="lbl-small" style="color:red;">(-)Cancel</span><input type="number" id="inv-baj" placeholder="0" oninput="calc()"></div>
                <div><span class="lbl-small" style="color:orange;">(-)Recog</span><input type="number" id="inv-rec" placeholder="0" oninput="calc()"></div>
            </div>
            
            <div style="background:#eafaf1; padding:10px; border:1px solid #d5f5e3; border-radius:5px; margin-top:10px;">
                <label style="font-weight:bold; font-size:0.8em; color:#27ae60;">AGREGAR TARJETA NUEVA (RUTA)</label>
                <div class="dynamic-row">
                    <input type="text" id="quick-clave" placeholder="Clave (C-100)" style="flex:1;">
                    <input type="text" id="quick-num" placeholder="# Numero" style="flex:1;">
                    <button class="btn-add" onclick="quickAddCard()" style="flex:1; background:#2ecc71; color:white; border:none;">+ AGREGAR</button>
                </div>
            </div>

            <div id="btn-conciliacion-container" style="display:none; margin-top:10px;">
                <button class="btn-danger" onclick="openConciliacion()">‚ö†Ô∏è ELIMINAR <span id="count-to-delete">0</span> TARJETAS DE LA BASE</button>
            </div>

            <label style="font-weight:bold; color:var(--secondary); display:block; margin-top:10px;">CONTEO F√çSICO ACTUAL</label>
            <input type="number" id="inv-fis" placeholder="Total en mano..." style="font-size:1.2em; font-weight:bold;" oninput="calc()">
            <div id="inv-msg" style="text-align:center; font-weight:bold; margin-top:5px;"></div>
        </div>

        <button class="btn-main" style="background:#e74c3c;" onclick="abrirVistaPrevia()">üìÑ GENERAR PDF (VISTA PREVIA)</button>
        <button class="btn-main" onclick="saveData()">üíæ GUARDAR DATOS</button>
    </div>

    <div id="view-ruta" class="view-section">
        <div class="card" style="border-left: 5px solid var(--route);">
            <div class="ruta-header-info">
                <h3>üöö COBROS EN RUTA</h3>
                <span id="ruta-total-cards" class="ruta-counter">Total: 0</span>
            </div>
            <p>Lista de: <strong id="ruta-zona-display">...</strong></p>
            <input type="text" id="search-ruta" placeholder="Buscar Tarjeta..." onkeyup="filtrarRuta()" style="margin-bottom:10px;">
            <div id="lista-ruta-container" class="ruta-list">
                <div style="padding:20px; text-align:center; color:#7f8c8d;">Selecciona una Zona arriba</div>
            </div>
        </div>
    </div>

    <div id="view-stats" class="view-section">
        <div class="card">
            <h3>üìà An√°lisis de Zona</h3>
            <p>Historial: <strong id="stat-zona-title"></strong></p>
            <div class="chart-grid"><div class="chart-box"><canvas id="adminChart"></canvas></div></div>
            <div style="overflow-x:auto;">
                <table class="data-table"><thead><tr><th>Fecha</th><th>Semana</th><th>Rec.</th><th>Com.</th><th>Acci√≥n</th></tr></thead><tbody id="admin-stats-body"></tbody></table>
            </div>
        </div>
    </div>

    <div id="view-usuarios" class="view-section"><div class="card" style="border-top:4px solid var(--blue);"><h3>Crear Usuario</h3><input type="text" id="new-user" placeholder="Nombre"><input type="text" id="new-pass" placeholder="Contrase√±a"><label class="lbl-small">Zonas:</label><div class="zones-grid" id="zones-checkboxes"></div><select id="new-role"><option value="cobrador">Cobrador</option><option value="admin">Admin</option></select><button class="btn-main" onclick="crearUsuario()">Guardar</button></div><div class="card"><h3>Usuarios</h3><div id="lista-usuarios"></div></div></div>
    
    <div id="view-base" class="view-section">
        <div class="card">
            <h3 style="text-align:center; color:var(--primary); border-bottom:2px solid var(--primary); padding-bottom:5px;">Total en Base: <span id="db-total-count">0</span></h3>
            <button class="btn-main" style="background:#3498db; margin-bottom:15px;" onclick="openHistory()">üìú VER HISTORIAL DE MOVIMIENTOS</button>
        </div>
        
        <div class="card" style="border-top: 4px solid var(--accent);">
            <h3>Agregar Tarjeta Manual</h3>
            <div class="dynamic-row">
                <input type="text" id="manual-clave" placeholder="Clave (Ej: C-101)">
                <input type="text" id="manual-num" placeholder="N√∫mero">
            </div>
            <div style="display:flex; gap:5px;">
                <button class="btn-main" onclick="guardarTarjetaManual()">Guardar</button>
                <button class="btn-clear" onclick="limpiarManual()">Limpiar</button>
            </div>
        </div>
        <div class="card">
            <h3>Carga Masiva (CSV)</h3>
            <input type="file" id="csvInput">
            <div style="display:flex; gap:5px;">
                <button class="btn-main" onclick="uploadCSV()">Subir Archivo</button>
                <button class="btn-clear" onclick="limpiarCSV()">Limpiar Archivo</button>
            </div>
        </div>
        
        <div class="card" style="background:#ffecec; border:1px solid red;">
            <h3 style="color:red; margin-top:0;">‚ö†Ô∏è Zona de Peligro</h3>
            <button class="btn-danger" onclick="eliminarDuplicadosZona()">üßπ ELIMINAR DUPLICADOS</button>
            <button class="btn-danger" style="margin-top:10px; background:darkred;" onclick="borrarTodaLaZona()">üóëÔ∏è BORRAR TODA LA ZONA</button>
        </div>

        <div class="card">
            <input type="text" id="search" placeholder="Buscar Clave o N√∫mero..." onkeyup="filtrar()">
            <div style="max-height:400px; overflow-y:scroll; margin-top:10px;">
                <table class="data-table" id="table-db">
                    <thead><tr><th>Clave</th><th>#</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="db-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="view-dashboard" class="view-section">
        <div class="card">
            <div style="border-bottom:1px solid #eee; margin-bottom:15px; padding-bottom:10px;"><h3>Hola, <span id="dash-name"></span> üëã</h3><p>Zona: <strong id="dash-zona"></strong></p><div style="margin-top:10px; background:#f0f0f0; padding:10px; border-radius:5px;"><label style="font-size:0.7em;">FILTRAR</label><div style="display:flex; gap:5px; margin-top:5px;"><input type="date" id="dash-start" onchange="cargarDash()"><input type="date" id="dash-end" onchange="cargarDash()"></div></div></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;"><div class="stat-box green"><span class="stat-num" id="kpi-cobradas">0 / 0</span><small>Cobradas</small></div><div class="stat-box blue"><span class="stat-num" id="kpi-com">L.0</span><small>Mi Comisi√≥n</small></div></div>
            <div style="text-align:center; margin-bottom:20px;"><span style="font-size:2em; font-weight:bold; color:#333;" id="kpi-recaudo">L. 0.00</span><br><small>RECAUDADO</small></div>
            <div class="chart-grid"><div class="chart-box"><canvas id="chartEfficiency"></canvas><div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); pointer-events:none;"><span id="chart-center-val" style="font-size:1.5em; font-weight:bold;">0%</span></div></div><div class="chart-box"><canvas id="chartMoney"></canvas></div></div>
            <h4 style="margin-bottom:5px;">üìù Detalle</h4><div style="overflow-x:auto;"><table class="data-table"><thead><tr><th>Fecha</th><th>Tarjetas</th><th>Recaudo</th><th>Comisi√≥n</th></tr></thead><tbody id="dash-history-body"></tbody></table></div>
        </div>
    </div>
</div>

<div id="seccion-impresion">
    <div class="pdf-header"><div><h1>COMERCIAL MILAGRO</h1><p id="p-semana-title" style="font-size:16px; font-weight:bold;"></p></div><div style="text-align:right;"><div>ZONA: <strong id="p-zona" style="font-size:16px; text-transform:uppercase;"></strong></div><div>FECHA: <span id="p-fecha"></span></div></div></div>
    <div class="pdf-title">I. DETALLE INGRESOS</div><table class="pdf-table" id="p-tbl-tal"></table>
    <div class="pdf-title">II. DETALLE EGRESOS Y BANCO</div><table class="pdf-table" id="p-tbl-gas"></table><table class="pdf-table" id="p-tbl-ban" style="margin-top:10px;"></table>
    <div class="pdf-summary-container"><div style="text-align:center; font-weight:bold; border-bottom:1px solid #ccc; margin-bottom:10px;">LIQUIDACI√ìN FINAL</div><div class="pdf-sum-row plus"><span>(+) TOTAL RECAUDADO</span><span id="p-rec">L. 0.00</span></div><div class="pdf-sum-row minus pdf-comision-box"><span>(-) COMISI√ìN COBRADOR (10%)</span><span id="p-com">L. 0.00</span></div><div class="pdf-sum-row minus"><span>(-) TOTAL GASTOS</span><span id="p-gas">L. 0.00</span></div><div class="pdf-sum-row minus"><span>(-) TOTAL BANCO</span><span id="p-ban">L. 0.00</span></div><div class="pdf-neto-box">(=) NETO A ENTREGAR: <span id="p-neto">L. 0.00</span></div></div>
    <div class="pdf-pressure-box"><b>EFICIENCIA DE COBRO:</b><br>Se cobraron <span id="p-cob" style="font-size:16px; font-weight:bold;">0</span> tarjetas de un total de <span id="p-tot">0</span> en ruta.<br>Tarjetas sin cobro: <span id="p-nocob" style="color:red; font-weight:bold;">0</span></div>
    <div class="pdf-title" style="margin-top:20px;">IV. CONTROL DE INVENTARIO</div><div class="pdf-inv-grid"><div class="pdf-inv-item"><b id="p-sys">0</b>Base</div><div class="pdf-inv-item"><b id="p-new" style="color:green;">0</b>(+)Nuevas</div><div class="pdf-inv-item"><b id="p-baj" style="color:red;">0</b>(-)Cancel</div><div class="pdf-inv-item"><b id="p-recog" style="color:orange;">0</b>(-)Recog</div><div class="pdf-inv-item" style="background:#eee;"><b id="p-teo">0</b>Te√≥rico</div><div class="pdf-inv-item" style="border:2px solid #333;"><b id="p-fis">0</b>F√≠sico</div></div><div style="text-align:center; margin-top:5px; font-weight:bold;" id="p-msg"></div>
    
    <div class="pdf-title" style="margin-top:20px;">V. DETALLE DE TARJETAS RETIRADAS</div>
    <div id="p-grid-bajas" class="pdf-compact-grid"></div>

    <div class="pdf-title" style="margin-top:20px;">VI. TARJETAS NUEVAS INGRESADAS</div>
    <div id="p-grid-nuevas" class="pdf-compact-grid"></div>

    <div class="pdf-evidence-section"><div id="p-gal-mixed"></div></div>
    <div class="pdf-signatures"><div class="sign-line">Firma Cobrador</div><div class="sign-line">Firma Recibido</div></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, orderBy, limit, writeBatch, updateDoc } 
    from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // --- AUTO-UPDATE VERSION 49 ---
    const VERSION_ACTUAL = "49.0"; 

    const firebaseConfig = { apiKey: "AIzaSyAXqQgW1goVNrNUVo6DSBBI9mutO4jvgqU", authDomain: "sistema-inventario-tarjetas.firebaseapp.com", projectId: "sistema-inventario-tarjetas", storageBucket: "sistema-inventario-tarjetas.firebasestorage.app", messagingSenderId: "44500678697", appId: "1:44500678697:web:c8559caa8e66a293d4c438", measurementId: "G-8W1DYQP0G3" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const ZONAS = ["Balfate", "Sonaguera", "Planes Jutiapa", "Bonito Oriental", "Margen Izquierda", "Faous", "Honduras Aguan", "Saba Tocoa", "Trujillo", "Saba Olanchito", "Olancho"];
    let currentUser = null;
    let totalSys = 0, toDeleteCount = 0;
    let chartInst = null, adminChartInst = null;
    let chartEff = null, chartMon = null;
    let allCardsCache = []; 
    let sessionNewCards = [];
    let currentPayId = null;

    // --- CHECK VERSION ---
    const checkVersion = () => {
        const storedVer = localStorage.getItem('milagro_version');
        if (storedVer !== VERSION_ACTUAL) {
            localStorage.setItem('milagro_version', VERSION_ACTUAL);
            if (window.location.search.indexOf('v=') === -1) {
                window.location.href = window.location.pathname + '?v=' + VERSION_ACTUAL;
            } else {
                window.location.reload(true);
            }
        }
    };

    window.addEventListener('load', async () => {
        checkVersion();
        
        const zBox = document.getElementById('zones-checkboxes');
        ZONAS.forEach(z => zBox.innerHTML += `<label class="zone-check"><input type="checkbox" value="${z}"> ${z}</label>`);
        const saved = JSON.parse(sessionStorage.getItem('gyg_user'));
        if(saved) loginSuccess(saved);
        
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), 0, 1);
        document.getElementById('dash-start').value = firstDay.toISOString().split('T')[0];
        document.getElementById('dash-end').value = now.toISOString().split('T')[0];
        
        setTimeout(cargarBorrador, 1000);
        document.body.addEventListener('input', guardarBorrador);
        document.body.addEventListener('change', guardarBorrador);
    });

    window.guardarBorrador = () => {
        if(!currentUser || currentUser.role !== 'admin') return;
        document.querySelectorAll('input, select').forEach(i => {
            if(i.type !== 'checkbox' && i.type !== 'radio' && i.type !== 'file') i.setAttribute('value', i.value);
        });
        const borrador = {
            talonarios: document.getElementById('lista-talonarios').innerHTML,
            gastos: document.getElementById('lista-gastos').innerHTML,
            banco: document.getElementById('lista-banco').innerHTML,
            inputs: {
                fecha: document.getElementById('fecha_liquidacion').value,
                semana: document.getElementById('txt_semana').value,
                invNew: document.getElementById('inv-new').value,
                invBaj: document.getElementById('inv-baj').value,
                invRec: document.getElementById('inv-rec').value,
                invFis: document.getElementById('inv-fis').value
            },
            nuevasSession: sessionNewCards
        };
        localStorage.setItem('milagro_backup', JSON.stringify(borrador));
    };

    window.cargarBorrador = () => {
        const backup = localStorage.getItem('milagro_backup');
        if(backup && currentUser && currentUser.role === 'admin') {
            const data = JSON.parse(backup);
            if(data.talonarios || data.gastos || data.banco || data.inputs.invFis) {
                document.getElementById('lista-talonarios').innerHTML = data.talonarios;
                document.getElementById('lista-gastos').innerHTML = data.gastos;
                document.getElementById('lista-banco').innerHTML = data.banco;
                document.getElementById('fecha_liquidacion').value = data.inputs.fecha;
                document.getElementById('txt_semana').value = data.inputs.semana;
                document.getElementById('inv-new').value = data.inputs.invNew;
                document.getElementById('inv-baj').value = data.inputs.invBaj;
                document.getElementById('inv-rec').value = data.inputs.invRec;
                document.getElementById('inv-fis').value = data.inputs.invFis;
                if(data.nuevasSession) sessionNewCards = data.nuevasSession;
                document.querySelectorAll('input').forEach(i => { i.value = i
