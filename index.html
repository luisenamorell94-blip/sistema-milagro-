<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema Milagro</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2c3e50">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ESTILOS GENERALES */
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #27ae60; --blue: #2980b9; --money: #117a65; --bank: #8e44ad; --alert: #c0392b; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; margin: 0; padding: 10px; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .login-box { background: white; padding: 40px 30px; border-radius: 15px; width: 90%; max-width: 340px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        .cm-logo { font-size: 3em; font-weight: 900; color: var(--primary); border: 4px solid var(--primary); padding: 10px; border-radius: 10px; display: inline-block; margin-bottom: 20px; letter-spacing: -2px; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 16px; text-align: center; color: #333; background: #f9f9f9; }
        .login-btn { background: var(--blue); color: white; border: none; padding: 15px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 20px; transition: background 0.3s; }
        .login-btn:hover { background: #1c5985; }

        /* UI APP */
        header { background: linear-gradient(135deg, #1a252f 0%, #2c3e50 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #e0e0e0; border-radius: 5px; font-weight: bold; cursor: pointer; white-space: nowrap; color: #555; }
        .tab-btn.active { background: var(--blue); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }

        /* ELEMENTOS UI */
        .item-container { border: 1px solid #eee; background: #fafafa; padding: 8px; margin-bottom: 8px; border-radius: 6px; }
        .dynamic-row { display: flex; gap: 5px; margin-bottom: 5px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9em; }
        .lbl-small { font-size: 0.7em; color: #666; display: block; margin-bottom: 2px; }
        .btn-add { width: 100%; padding: 10px; background: #ecf0f1; border: 1px dashed #bdc3c7; cursor: pointer; margin-top: 5px; font-weight: bold; }
        .btn-del { background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 5px 15px; font-weight: bold; cursor: pointer; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 15px; width: 100%; border-radius: 6px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
        .btn-clear { background: #7f8c8d; color: white; border: none; padding: 15px; width: 100%; border-radius: 6px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
        .btn-danger { background: var(--alert); color: white; border: none; padding: 15px; width: 100%; border-radius: 6px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
        .btn-del-row { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8em; }
        .btn-remove-pdf { background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-weight: bold; font-size: 10px; margin-left: 5px; }

        /* GALERIA & CHART */
        .gallery { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
        .thumb { width: 70px; height: 70px; background: #eee; border-radius: 5px; position: relative; overflow: hidden; border: 1px solid #ccc; }
        .thumb img { width: 100%; height: 100%; object-fit: cover; }
        .thumb-x { position: absolute; top: 0; right: 0; background: rgba(255,0,0,0.8); color: white; border: none; width: 20px; height: 20px; cursor: pointer; font-weight: bold; }
        .btn-cam { background: var(--blue); color: white; padding: 10px; border: none; border-radius: 5px; width: 100%; cursor: pointer; margin-top: 5px; font-weight: bold; }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .chart-box { background: white; padding: 10px; border-radius: 8px; border: 1px solid #eee; height: 220px; display: flex; justify-content: center; align-items: center; position: relative; }
        
        /* DATA TABLE */
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.85em; margin-top: 10px; }
        .data-table th { background: #ecf0f1; padding: 8px; text-align: left; border-bottom: 2px solid #bdc3c7; }
        .data-table td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; }

        /* RESULTADOS CARD */
        .money-card { border-left: 5px solid var(--money); background: #f4fbf9; }
        .money-result { font-size: 1.8em; font-weight: bold; color: var(--money); display:block; text-align:right; }
        .row-det { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95em; border-bottom: 1px dotted #eee; padding-bottom: 2px; }
        .efficiency-bar { height: 10px; background: #eee; border-radius: 5px; margin-top: 5px; overflow: hidden; }
        .efficiency-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s; }
        .efficiency-text { text-align: center; font-weight: bold; font-size: 0.9em; margin-top: 5px; color: #333; }

        /* DASHBOARD KPIS */
        .kpi-row { display: flex; justify-content: space-between; margin-bottom: 15px; gap: 10px; }
        .kpi-card { flex: 1; padding: 15px; border-radius: 8px; color: white; text-align: center; }
        .kpi-card.green { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .kpi-card.blue { background: linear-gradient(135deg, #3498db, #2980b9); }
        .kpi-card strong { font-size: 1.4em; display: block; }

        /* GESTI√ìN USUARIOS */
        .zones-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin: 10px 0; text-align: left; max-height: 150px; overflow-y: auto; background: #fff; border: 1px solid #ddd; padding: 5px; }
        .zone-check { display: flex; align-items: center; font-size: 0.85em; padding: 5px; border-bottom: 1px solid #eee; }
        .user-item { display: flex; justify-content: space-between; background: #fff; padding: 10px; border-bottom: 1px solid #eee; align-items: center; }

        /* MODALES */
        .modal-overlay { display: none; position: fixed; z-index: 20000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 20px; width: 90%; max-width: 500px; border-radius: 10px; position: relative; box-shadow: 0 5px 25px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }
        .modal-header { font-weight: bold; font-size: 1.2em; margin-bottom: 15px; color: #2c3e50; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .modal-counter { font-size: 2.5em; font-weight: bold; text-align: center; margin: 10px 0; display: block; color: #c0392b; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        /* LOADING */
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 30000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* IMPRESI√ìN (PDF) */
        #seccion-impresion { display: none; }
        @media print {
            body { background: white; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; color: #333; }
            .container, #login-screen, #printControls, .modal-overlay, .btn-remove-pdf, #loading-overlay { display: none !important; }
            #seccion-impresion { display: block !important; padding: 20px; box-sizing: border-box; }
            
            .pdf-header { display: flex; justify-content: space-between; border-bottom: 3px solid #2c3e50; margin-bottom: 10px; padding-bottom: 5px; }
            .pdf-header h1 { margin: 0; font-size: 22px; text-transform: uppercase; color: #2c3e50; }
            .pdf-title { background: #eee; font-weight: bold; padding: 3px; border-bottom: 1px solid #000; font-size: 11px; margin: 10px 0 3px 0; text-align: center; text-transform: uppercase; }
            .pdf-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 5px; }
            .pdf-table th, .pdf-table td { border-bottom: 1px dotted #ccc; padding: 3px; text-align: left; }
            .pdf-summary-container { width: 100%; max-width: 400px; margin-left: auto; margin-top: 10px; border: 2px solid #333; padding: 10px; background: #fdfdfd; page-break-inside: avoid; }
            .pdf-sum-row { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 12px; }
            .pdf-sum-row.plus { color: #27ae60; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 3px; }
            .pdf-sum-row.minus { color: #c0392b; }
            .pdf-comision-box { background: #fff3cd; border: 1px solid #ffeeba; padding: 2px; font-weight: bold; color: #856404; }
            .pdf-neto-box { border-top: 3px double #333; margin-top: 5px; padding-top: 5px; font-size: 16px; font-weight: bold; color: #2c3e50; text-align: right; background: #eaf2f8; padding: 5px; }
            .pdf-pressure-box { border: 2px solid #2c3e50; background: #f4f6f7; padding: 5px; margin-top: 10px; text-align: center; font-size: 12px; page-break-inside: avoid; }
            .pdf-inv-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; background: #f4f6f7; padding: 5px; border: 1px solid #ddd; font-size: 10px; text-align: center; margin-top: 10px; page-break-inside: avoid; }
            .pdf-inv-item b { display: block; font-size: 12px; margin-bottom: 2px; }
            .pdf-compact-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; font-size: 10px; border: 1px solid #ccc; padding: 5px; background: #fff; page-break-inside: avoid; }
            .baja-item-pdf { border: 1px solid #eee; padding: 3px; text-align: center; background: #fafafa; }
            .baja-item-pdf strong { color: #333; font-size: 11px; }
            .pdf-evidence-section { page-break-before: always; margin-top: 0; }
            .pdf-evidence-block { width: 100%; height: 45vh; margin-bottom: 2vh; page-break-inside: avoid; break-inside: avoid; border: 1px solid #eee; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 10px; box-sizing: border-box; }
            .pdf-evidence-label { width: 100%; text-align: left; font-weight: bold; font-size: 12px; border-bottom: 2px solid #2c3e50; margin-bottom: 10px; text-transform: uppercase; color: #2c3e50; }
            .pdf-image-container { flex: 1; width: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; }
            .pdf-image-container img { max-width: 98%; max-height: 100%; object-fit: contain; }
            .pdf-signatures { display: flex; justify-content: space-between; margin-top: 30px; padding: 0 40px; page-break-inside: avoid; }
            .sign-line { border-top: 1px solid black; width: 40%; text-align: center; font-size: 12px; padding-top: 5px; }
        }
    </style>
</head>
<body>

<div id="loading-overlay"><div class="spinner"></div><h3 style="margin-top:20px;">Procesando...</h3></div>

<div id="login-screen">
    <div class="login-box">
        <div class="cm-logo">CM</div>
        <h3 style="margin-top:0; color:#333;">COMERCIAL MILAGRO</h3>
        <input type="text" id="loginUser" placeholder="Usuario">
        <input type="password" id="loginPass" placeholder="Contrase√±a">
        <button class="login-btn" onclick="iniciarSesion()">ENTRAR AL SISTEMA</button>
        <p id="loginMsg" style="color:#c0392b; display:none; margin-top:10px; font-weight:bold;"></p>
    </div>
</div>

<div id="printControls" style="display:none; position:fixed; top:0; left:0; width:100%; background:#2c3e50; padding:15px; justify-content:space-around; z-index:10000; box-shadow:0 4px 10px rgba(0,0,0,0.3);">
    <button onclick="cerrarVistaPrevia()" style="padding:10px 20px; border-radius:20px; font-weight:bold; border:none; background:#e74c3c; color:white;">‚ùå VOLVER</button>
    <button onclick="window.print()" style="padding:10px 20px; border-radius:20px; font-weight:bold; border:none; background:#2ecc71; color:white;">üñ®Ô∏è IMPRIMIR</button>
</div>

<div id="conciliacionModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" onclick="closeConciliacion()">√ó</span>
        <div class="modal-header">‚ö†Ô∏è BAJA DE TARJETAS</div>
        <p style="text-align:center;">Busca y elimina la tarjeta. Se guardar√° en el historial.</p>
        <div style="background:#f9f9f9; padding:10px; border-radius:10px; text-align:center;">
            <small>Faltan por eliminar:</small>
            <span class="modal-counter" id="cards-to-delete-count">0</span>
        </div>
        <div style="margin-top:15px;">
            <input type="text" id="modal-search" placeholder="Buscar Clave o N√∫mero..." onkeyup="searchForDeletion()" style="font-size:1.2em; text-align:center; margin-bottom:10px;">
            <div style="max-height:250px; overflow-y:scroll; border:1px solid #eee;">
                <table class="data-table"><thead><tr><th>Clave</th><th>#</th><th>Acci√≥n</th></tr></thead><tbody id="modal-table-body"></tbody></table>
            </div>
        </div>
    </div>
</div>

<div id="historyModal" class="modal-overlay">
    <div class="modal-content" style="max-width:700px;">
        <span class="close-modal" onclick="closeHistory()">√ó</span>
        <div class="modal-header">üìú HISTORIAL DE MOVIMIENTOS</div>
        <div style="max-height:400px; overflow-y:scroll;">
            <table class="data-table">
                <thead><tr><th>Fecha</th><th>Tarjeta</th><th>Acci√≥n</th><th>Usuario</th></tr></thead>
                <tbody id="history-table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="container" id="app-container" style="display:none;">
    <header>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="font-size: 1.8em;">üè¶</div>
            <div><h2 style="margin:0; font-size:1.1em;">COMERCIAL MILAGRO</h2><small id="user-display"></small></div>
        </div>
        <button onclick="logout()" style="background:transparent; border:1px solid white; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;">Cerrar</button>
    </header>

    <div class="card" style="background:#fff3cd; border:1px solid #ffeeba; padding:10px;">
        <label style="font-weight:bold; font-size:0.8em; color:#856404;">ZONA DE TRABAJO</label>
        <select id="zonaSelect" style="margin-top:5px; font-weight:bold; width:100%;"></select>
    </div>

    <div class="tabs" id="tabs-admin">
        <button class="tab-btn active" onclick="nav('cuadre')">üìù Liquidaci√≥n</button>
        <button class="tab-btn" onclick="nav('stats')">üìä Estad√≠sticas</button>
        <button class="tab-btn" onclick="nav('usuarios')">üë• Usuarios</button>
        <button class="tab-btn" onclick="nav('base')">üóÉÔ∏è Base Datos</button>
    </div>
    <div class="tabs" id="tabs-cobrador" style="display:none;">
        <button class="tab-btn active" style="background:var(--accent); color:white;">üìà Mi Rendimiento</button>
    </div>

    <div id="view-cuadre" class="view-section active">
        <div class="card" style="text-align:center;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div><label class="lbl-small">FECHA CORTE</label><input type="date" id="fecha_liquidacion" style="font-weight:bold; text-align:center;"></div>
                <div><label class="lbl-small">PERIODO / SEMANA</label><input type="text" id="txt_semana" placeholder="Ej: SEMANA 1 ENERO" style="font-weight:bold; text-align:center;"></div>
            </div>
        </div>

        <div class="card money-card">
            <h3 style="margin:0 0 10px 0; color:var(--money);">1. Ingresos</h3>
            <div id="lista-talonarios"></div>
            <button class="btn-add" onclick="addTal()">+ Agregar Talonario</button>
            <div style="margin-top:15px; padding:10px; background:white; border-radius:5px; border:1px solid #ddd;">
                <label style="font-size:0.8em; font-weight:bold; color:#555;">EFICIENCIA DE COBRO</label>
                <div class="efficiency-text" id="eff-text">Cobraste 0 de 0 (0%)</div>
                <div class="efficiency-bar"><div class="efficiency-fill" id="eff-bar"></div></div>
            </div>
            <div style="text-align:right; font-weight:bold; margin-top:10px; font-size:1.1em; color:var(--money);">Total Recaudado: <span id="lbl_tal">L. 0.00</span></div>
        </div>

        <div class="card" style="border-left: 5px solid #c0392b;">
            <h3 style="margin:0 0 10px 0; color:#c0392b;">2. Deducciones</h3>
            <label style="font-weight:bold; font-size:0.9em;">A. Gastos Operativos</label>
            <div id="lista-gastos"></div>
            <button class="btn-add" onclick="addGas()">+ Gasto</button>
            <div style="margin-top:5px;"><input type="file" id="in-gas-pic" accept="image/*" multiple hidden onchange="procPic(this, 'gal-gas')"><button class="btn-cam" onclick="document.getElementById('in-gas-pic').click()">üì∑ FOTOS GASTOS</button><div id="gal-gas" class="gallery"></div></div>
            <div style="text-align:right; font-weight:bold; margin:5px 0 15px 0; color:#c0392b;">Subtotal Gastos: <span id="lbl_gas">L. 0.00</span></div>
            <hr style="border:0; border-top:1px dashed #ccc; margin:10px 0;">
            <label style="font-weight:bold; font-size:0.9em; color:var(--bank);">B. Dep√≥sitos Banco</label>
            <div id="lista-banco"></div>
            <button class="btn-add" onclick="addBan()">+ Voucher</button>
            <div style="margin-top:5px;"><input type="file" id="in-ban-pic" accept="image/*" multiple hidden onchange="procPic(this, 'gal-ban')"><button class="btn-cam" onclick="document.getElementById('in-ban-pic').click()" style="background:var(--bank);">üì∑ FOTOS BANCO</button><div id="gal-ban" class="gallery"></div></div>
            <div style="text-align:right; font-weight:bold; margin-top:5px; color:var(--bank);">Subtotal Banco: <span id="lbl_ban">L. 0.00</span></div>
        </div>

        <div class="card">
            <h3 style="margin:0 0 10px 0;">3. Resumen Final</h3>
            <div style="background:#f9f9f9; padding:15px; border-radius:5px;">
                <div class="row-det"><span>(+) Recaudado:</span><span id="res_ing">L. 0.00</span></div>
                <div class="row-det"><span>(-) Comisi√≥n (10%):</span><span id="res_com" style="color:var(--alert);">L. 0.00</span></div>
                <div class="row-det"><span>(-) Total Gastos:</span><span id="res_gas" style="color:var(--alert);">L. 0.00</span></div>
                <div class="row-det"><span>(-) Total Banco:</span><span id="res_ban" style="color:var(--bank);">L. 0.00</span></div>
                <div style="border-top:2px dashed #333; margin-top:10px; padding-top:10px;"><span style="font-size:0.9em; font-weight:bold;">EFECTIVO NETO A ENTREGAR:</span><span id="res_neto" class="money-result">L. 0.00</span></div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin:0 0 10px 0; color:var(--primary);">üì¶ Inventario Tarjetas</h3>
            <div style="text-align:center; margin-bottom:5px;">Sistema: <strong id="total-sys">0</strong></div>
            <div class="dynamic-row">
                <div><span class="lbl-small" style="color:green;">(+)Nuevas</span><input type="number" id="inv-new" placeholder="0"></div>
                <div><span class="lbl-small" style="color:red;">(-)Cancel</span><input type="number" id="inv-baj" placeholder="0" oninput="calc()"></div>
                <div><span class="lbl-small" style="color:orange;">(-)Recog</span><input type="number" id="inv-rec" placeholder="0" oninput="calc()"></div>
            </div>
            
            <div id="btn-conciliacion-container" style="display:none; margin-top:10px;">
                <button class="btn-danger" style="animation: pulse 1s infinite;" onclick="openConciliacion()">‚ö†Ô∏è ELIMINAR <span id="count-to-delete">0</span> TARJETAS DE LA BASE</button>
                <style>@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }</style>
            </div>

            <label style="font-weight:bold; color:var(--secondary); display:block; margin-top:10px;">CONTEO F√çSICO ACTUAL</label>
            <input type="number" id="inv-fis" placeholder="Total en mano..." style="font-size:1.2em; font-weight:bold;" oninput="calc()">
            <div id="inv-msg" style="text-align:center; font-weight:bold; margin-top:5px;"></div>
        </div>

        <button class="btn-main" style="background:#e74c3c;" onclick="abrirVistaPrevia()">üìÑ GENERAR PDF (VISTA PREVIA)</button>
        <button class="btn-main" onclick="saveData()">üíæ GUARDAR DATOS</button>
    </div>

    <div id="view-stats" class="view-section">
        <div class="card">
            <h3>üìà An√°lisis de Zona</h3>
            <p>Historial: <strong id="stat-zona-title"></strong></p>
            <div class="chart-grid"><div class="chart-box"><canvas id="adminChart"></canvas></div></div>
            <div style="overflow-x:auto;">
                <table class="data-table"><thead><tr><th>Fecha</th><th>Semana</th><th>Rec.</th><th>Com.</th><th>Acci√≥n</th></tr></thead><tbody id="admin-stats-body"></tbody></table>
            </div>
        </div>
    </div>

    <div id="view-usuarios" class="view-section"><div class="card" style="border-top:4px solid var(--blue);"><h3>Crear Usuario</h3><input type="text" id="new-user" placeholder="Nombre"><input type="text" id="new-pass" placeholder="Contrase√±a"><label class="lbl-small">Zonas:</label><div class="zones-grid" id="zones-checkboxes"></div><select id="new-role"><option value="cobrador">Cobrador</option><option value="admin">Admin</option></select><button class="btn-main" onclick="crearUsuario()">Guardar</button></div><div class="card"><h3>Usuarios</h3><div id="lista-usuarios"></div></div></div>
    
    <div id="view-base" class="view-section">
        <div class="card">
            <h3 style="text-align:center; color:var(--primary); border-bottom:2px solid var(--primary); padding-bottom:5px;">Total en Base: <span id="db-total-count">0</span></h3>
            <button class="btn-main" style="background:#3498db; margin-bottom:15px;" onclick="openHistory()">üìú VER HISTORIAL DE MOVIMIENTOS</button>
        </div>
        
        <div class="card" style="border-top: 4px solid var(--accent);">
            <h3>Agregar Tarjeta Manual</h3>
            <div class="dynamic-row">
                <input type="text" id="manual-clave" placeholder="Clave (Ej: C-101)">
                <input type="text" id="manual-num" placeholder="N√∫mero">
            </div>
            <div style="display:flex; gap:5px;">
                <button class="btn-main" onclick="guardarTarjetaManual()">Guardar</button>
                <button class="btn-clear" onclick="limpiarManual()">Limpiar</button>
            </div>
        </div>
        <div class="card">
            <h3>Carga Masiva (CSV)</h3>
            <input type="file" id="csvInput">
            <div style="display:flex; gap:5px;">
                <button class="btn-main" onclick="uploadCSV()">Subir Archivo</button>
                <button class="btn-clear" onclick="limpiarCSV()">Limpiar Archivo</button>
            </div>
        </div>
        
        <div class="card" style="background:#ffecec; border:1px solid red;">
            <h3 style="color:red; margin-top:0;">‚ö†Ô∏è Zona de Peligro</h3>
            <button class="btn-danger" onclick="eliminarDuplicadosZona()">üßπ ELIMINAR DUPLICADOS</button>
            <button class="btn-danger" style="margin-top:10px; background:darkred;" onclick="borrarTodaLaZona()">üóëÔ∏è BORRAR TODA LA ZONA</button>
        </div>

        <div class="card">
            <input type="text" id="search" placeholder="Buscar Clave o N√∫mero..." onkeyup="filtrar()">
            <div style="max-height:400px; overflow-y:scroll; margin-top:10px;">
                <table class="data-table" id="table-db">
                    <thead><tr><th>Clave</th><th>#</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="db-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="view-dashboard" class="view-section">
        <div class="card">
            <div style="border-bottom:1px solid #eee; margin-bottom:15px; padding-bottom:10px;"><h3>Hola, <span id="dash-name"></span> üëã</h3><p style="margin:0;">Zona: <strong id="dash-zona"></strong></p><div style="margin-top:10px; background:#f0f0f0; padding:10px; border-radius:5px;"><label style="font-size:0.7em; font-weight:bold;">FILTRAR (Semana/Quincena)</label><div style="display:flex; gap:5px; margin-top:5px;"><div style="flex:1"><span class="lbl-small">Desde:</span><input type="date" id="dash-start" onchange="cargarDash()"></div><div style="flex:1"><span class="lbl-small">Hasta:</span><input type="date" id="dash-end" onchange="cargarDash()"></div></div></div></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;"><div class="stat-box green"><span class="stat-num" id="kpi-cobradas">0 / 0</span><small>Cobradas</small></div><div class="stat-box blue"><span class="stat-num" id="kpi-com">L.0</span><small>Mi Comisi√≥n</small></div></div>
            <div style="text-align:center; margin-bottom:20px;"><span style="font-size:2em; font-weight:bold; color:#333;" id="kpi-recaudo">L. 0.00</span><br><small>RECAUDADO</small></div>
            <div class="chart-grid"><div class="chart-box"><canvas id="chartEfficiency"></canvas><div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); pointer-events:none;"><span id="chart-center-val" style="font-size:1.5em; font-weight:bold;">0%</span></div></div><div class="chart-box"><canvas id="chartMoney"></canvas></div></div>
            <h4 style="margin-bottom:5px;">üìù Detalle</h4><div style="overflow-x:auto;"><table class="data-table"><thead><tr><th>Fecha</th><th>Tarjetas</th><th>Recaudo</th><th>Comisi√≥n</th></tr></thead><tbody id="dash-history-body"></tbody></table></div>
        </div>
    </div>
</div>

<div id="seccion-impresion">
    <div class="pdf-header"><div><h1>COMERCIAL MILAGRO</h1><p id="p-semana-title" style="font-size:16px; font-weight:bold;"></p></div><div style="text-align:right;"><div>ZONA: <strong id="p-zona" style="font-size:16px; text-transform:uppercase;"></strong></div><div>FECHA: <span id="p-fecha"></span></div></div></div>
    <div class="pdf-title">I. DETALLE INGRESOS</div><table class="pdf-table" id="p-tbl-tal"></table>
    <div class="pdf-title">II. DETALLE EGRESOS Y BANCO</div><table class="pdf-table" id="p-tbl-gas"></table><table class="pdf-table" id="p-tbl-ban" style="margin-top:10px;"></table>
    <div class="pdf-summary-container"><div style="text-align:center; font-weight:bold; border-bottom:1px solid #ccc; margin-bottom:10px;">LIQUIDACI√ìN FINAL</div><div class="pdf-sum-row plus"><span>(+) TOTAL RECAUDADO</span><span id="p-rec">L. 0.00</span></div><div class="pdf-sum-row minus pdf-comision-box"><span>(-) COMISI√ìN COBRADOR (10%)</span><span id="p-com">L. 0.00</span></div><div class="pdf-sum-row minus"><span>(-) TOTAL GASTOS</span><span id="p-gas">L. 0.00</span></div><div class="pdf-sum-row minus"><span>(-) TOTAL BANCO</span><span id="p-ban">L. 0.00</span></div><div class="pdf-neto-box">(=) NETO A ENTREGAR: <span id="p-neto">L. 0.00</span></div></div>
    <div class="pdf-pressure-box"><b>EFICIENCIA DE COBRO:</b><br>Se cobraron <span id="p-cob" style="font-size:16px; font-weight:bold;">0</span> tarjetas de un total de <span id="p-tot">0</span> en ruta.<br>Tarjetas sin cobro: <span id="p-nocob" style="color:red; font-weight:bold;">0</span></div>
    <div class="pdf-title" style="margin-top:20px;">IV. CONTROL DE INVENTARIO</div><div class="pdf-inv-grid"><div class="pdf-inv-item"><b id="p-sys">0</b>Base</div><div class="pdf-inv-item"><b id="p-new" style="color:green;">0</b>(+)Nuevas</div><div class="pdf-inv-item"><b id="p-baj" style="color:red;">0</b>(-)Cancel</div><div class="pdf-inv-item"><b id="p-recog" style="color:orange;">0</b>(-)Recog</div><div class="pdf-inv-item" style="background:#eee;"><b id="p-teo">0</b>Te√≥rico</div><div class="pdf-inv-item" style="border:2px solid #333;"><b id="p-fis">0</b>F√≠sico</div></div><div style="text-align:center; margin-top:5px; font-weight:bold;" id="p-msg"></div>
    
    <div class="pdf-title" style="margin-top:20px;">V. DETALLE DE TARJETAS RETIRADAS</div>
    <div id="p-grid-bajas" class="pdf-compact-grid"></div>

    <div class="pdf-evidence-section"><div id="p-gal-gas"></div><div id="p-gal-ban"></div></div><div class="pdf-signatures"><div class="sign-line">Firma Cobrador</div><div class="sign-line">Firma Recibido</div></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, orderBy, limit, writeBatch } 
    from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAXqQgW1goVNrNUVo6DSBBI9mutO4jvgqU", authDomain: "sistema-inventario-tarjetas.firebaseapp.com", projectId: "sistema-inventario-tarjetas", storageBucket: "sistema-inventario-tarjetas.firebasestorage.app", messagingSenderId: "44500678697", appId: "1:44500678697:web:c8559caa8e66a293d4c438", measurementId: "G-8W1DYQP0G3" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const ZONAS = ["Balfate", "Sonaguera", "Planes Jutiapa", "Bonito Oriental", "Margen Izquierda", "Faous", "Honduras Aguan", "Saba Tocoa", "Trujillo", "Saba Olanchito", "Olancho"];
    let currentUser = null;
    let totalSys = 0, toDeleteCount = 0;
    let chartInst = null, adminChartInst = null;
    let chartEff = null, chartMon = null;
    let allCardsCache = []; 

    window.addEventListener('load', async () => {
        const zBox = document.getElementById('zones-checkboxes');
        ZONAS.forEach(z => zBox.innerHTML += `<label class="zone-check"><input type="checkbox" value="${z}"> ${z}</label>`);
        const saved = JSON.parse(sessionStorage.getItem('gyg_user'));
        if(saved) loginSuccess(saved);
        
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), 0, 1);
        document.getElementById('dash-start').value = firstDay.toISOString().split('T')[0];
        document.getElementById('dash-end').value = now.toISOString().split('T')[0];
    });

    window.iniciarSesion = async () => {
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value.trim();
        if(u==='admin' && p==='2026') { loginSuccess({username:'Super Admin', role:'admin', zones:ZONAS}); return; }
        try {
            const q = query(collection(db, "usuarios"), where("username","==",u), where("password","==",p));
            const snap = await getDocs(q);
            if(!snap.empty) loginSuccess({...snap.docs[0].data(), id:snap.docs[0].id});
            else { document.getElementById('loginMsg').innerText="Datos incorrectos"; document.getElementById('loginMsg').style.display="block"; }
        } catch(e) { document.getElementById('loginMsg').innerText="Error conexi√≥n"; document.getElementById('loginMsg').style.display="block"; }
    }

    function loginSuccess(user) {
        currentUser = user;
        sessionStorage.setItem('gyg_user', JSON.stringify(user));
        document.getElementById('login-screen').style.display='none';
        document.getElementById('app-container').style.display='block';
        document.getElementById('user-display').innerText = user.username + (user.role==='admin'?' (Admin)':'');

        const sel = document.getElementById('zonaSelect'); sel.innerHTML="";
        const allowedZones = user.role==='admin' ? ZONAS : (user.zones || []);
        if(allowedZones.length===0) sel.innerHTML="<option>Sin Zona Asignada</option>";
        else allowedZones.forEach(z => sel.innerHTML+=`<option value="${z}">${z}</option>`);

        if(user.role==='admin') {
            document.getElementById('tabs-admin').style.display='flex';
            document.getElementById('tabs-cobrador').style.display='none';
            nav('cuadre'); loadUsers();
        } else {
            document.getElementById('tabs-admin').style.display='none';
            document.getElementById('tabs-cobrador').style.display='flex';
            document.getElementById('view-cuadre').remove();
            document.getElementById('view-base').remove();
            document.getElementById('view-usuarios').remove();
            document.getElementById('view-stats').remove();
            document.getElementById('view-dashboard').classList.add('active');
            
            setTimeout(() => {
                const firstZone = document.getElementById('zonaSelect').value;
                if(firstZone) cargarDash();
            }, 500);
        }
        cargarDatos();
        if(document.getElementById('fecha_liquidacion')) document.getElementById('fecha_liquidacion').valueAsDate=new Date();
        if(document.getElementById('lista-talonarios')) { addTal(); addGas(); addBan(); }
    }
    window.logout = () => { sessionStorage.clear(); location.reload(); };

    // --- LOGGING HELPER ---
    async function registrarLog(zona, clave, numero, accion) {
        await addDoc(collection(db, "historial_tarjetas"), {
            fecha: new Date(),
            zona: zona,
            clave: clave,
            numero: numero,
            accion: accion,
            usuario: currentUser.username
        });
    }

    // --- BASE DE DATOS ---
    window.guardarTarjetaManual = async () => {
        const k = document.getElementById('manual-clave').value.trim();
        const n = document.getElementById('manual-num').value.trim();
        const z = document.getElementById('zonaSelect').value;
        if(!k || !n) return alert("‚ö†Ô∏è FALTAN DATOS: Ingresa Clave y N√∫mero");
        try {
            await addDoc(collection(db, "tarjetas_fisicas"), { zona: z, clave: k, numero: n });
            await registrarLog(z, k, n, 'NUEVA');
            alert("‚úÖ Tarjeta Guardada");
            window.limpiarManual();
            cargarDatos();
        } catch(e) { alert("Error guardando: " + e.message); }
    };

    window.limpiarManual = () => {
        document.getElementById('manual-clave').value = "";
        document.getElementById('manual-num').value = "";
        document.getElementById('manual-clave').focus();
    };

    window.limpiarCSV = () => {
        document.getElementById('csvInput').value = "";
        alert("Archivo limpiado");
    };

    // ELIMINAR MANUAL (DESDE BASE DE DATOS)
    window.delRow = async (id) => {
        if(!confirm("¬øEliminar permanentemente?")) return;
        
        // Buscar info antes de borrar para el log
        const card = allCardsCache.find(c => c.id === id);
        
        document.getElementById(`tr-${id}`).remove(); 
        try { 
            await deleteDoc(doc(db, "tarjetas_fisicas", id)); 
            if(card) await registrarLog(card.zona, card.clave, card.numero, 'ELIMINADA MANUAL');
        } catch(e) { console.log("Error nube, visual ok"); }
        totalSys--; if(document.getElementById('total-sys')) document.getElementById('total-sys').innerText = totalSys; 
        if(document.getElementById('db-total-count')) document.getElementById('db-total-count').innerText = totalSys;
        calc();
    };

    window.borrarTodaLaZona = async () => {
        const z = document.getElementById('zonaSelect').value;
        if(!confirm(`‚ö†Ô∏è PELIGRO ‚ö†Ô∏è\n\n¬øBORRAR TODAS las tarjetas de ${z}?`)) return;
        
        const showLoading = document.getElementById('loading-overlay');
        showLoading.style.display = 'flex';

        const q = query(collection(db, "tarjetas_fisicas"), where("zona", "==", z));
        const snap = await getDocs(q);
        
        if(snap.empty) { showLoading.style.display = 'none'; return alert("No hay tarjetas para borrar."); }
        
        // CHUNK DELETION TO AVOID LIMITS
        const chunks = [];
        let batch = writeBatch(db);
        let count = 0;
        snap.forEach(doc => {
            batch.delete(doc.ref);
            count++;
            if(count >= 400) {
                chunks.push(batch.commit());
                batch = writeBatch(db);
                count = 0;
            }
        });
        if(count > 0) chunks.push(batch.commit());
        
        await Promise.all(chunks);
        await registrarLog(z, 'TODAS', 'TODAS', 'ELIMINACI√ìN MASIVA ZONA');
        
        showLoading.style.display = 'none';
        alert(`‚úÖ Eliminadas ${snap.size} tarjetas.`);
        cargarDatos();
    };

    window.eliminarDuplicadosZona = async () => {
        const z = document.getElementById('zonaSelect').value;
        if(!confirm(`¬øBuscar y eliminar duplicados en ${z}?`)) return;
        
        const showLoading = document.getElementById('loading-overlay');
        showLoading.style.display = 'flex';

        const q = query(collection(db, "tarjetas_fisicas"), where("zona", "==", z));
        const snap = await getDocs(q);
        
        if(snap.empty) { showLoading.style.display = 'none'; return alert("Zona vac√≠a."); }

        let seen = new Set();
        let duplicates = [];
        
        snap.forEach(doc => {
            const key = doc.data().clave.trim(); 
            if (seen.has(key)) duplicates.push(doc.ref);
            else seen.add(key);
        });

        if(duplicates.length === 0) { showLoading.style.display = 'none'; return alert("‚úÖ No se encontraron duplicados."); }
        
        // Batch Delete Duplicates
        const chunks = [];
        let batch = writeBatch(db);
        let count = 0;
        duplicates.forEach(ref => {
            batch.delete(ref);
            count++;
            if(count >= 400) {
                chunks.push(batch.commit());
                batch = writeBatch(db);
                count = 0;
            }
        });
        if(count > 0) chunks.push(batch.commit());
        
        await Promise.all(chunks);
        showLoading.style.display = 'none';
        alert(`‚úÖ Se eliminaron ${duplicates.length} duplicados.`);
        cargarDatos();
    };

    async function cargarDatos() {
        const z = document.getElementById('zonaSelect').value;
        const q = query(collection(db,"tarjetas_fisicas"), where("zona","==",z));
        const snap = await getDocs(q);
        totalSys = snap.size; 
        
        allCardsCache = [];
        snap.forEach(d => { allCardsCache.push({ id: d.id, ...d.data() }); });

        if(document.getElementById('total-sys')) document.getElementById('total-sys').innerText=totalSys;
        if(document.getElementById('db-total-count')) document.getElementById('db-total-count').innerText=totalSys;
        
        if(currentUser.role==='admin') {
            const tbody = document.getElementById('db-body'); tbody.innerHTML="";
            allCardsCache.forEach(d => {
                tbody.innerHTML += `<tr id="tr-${d.id}"><td>${d.clave}</td><td>${d.numero}</td><td><button class="btn-del-row" onclick="delRow('${d.id}')">Borrar</button></td></tr>`;
            });
        }
        calc();
    }

    window.filtrar = () => {
        const q = document.getElementById('search').value.toLowerCase();
        const rows = document.querySelectorAll('#db-body tr');
        rows.forEach(r => {
            const txt = r.innerText.toLowerCase();
            r.style.display = txt.includes(q) ? '' : 'none';
        });
    };

    // --- CONCILIACI√ìN & HISTORIAL ---
    window.openConciliacion = () => {
        document.getElementById('conciliacionModal').style.display = 'flex';
        document.getElementById('cards-to-delete-count').innerText = toDeleteCount;
        renderModalTable(allCardsCache);
    }
    window.closeConciliacion = () => { document.getElementById('conciliacionModal').style.display = 'none'; }
    window.searchForDeletion = () => {
        const term = document.getElementById('modal-search').value.toLowerCase();
        const filtered = allCardsCache.filter(c => c.clave.toLowerCase().includes(term) || c.numero.toLowerCase().includes(term));
        renderModalTable(filtered);
    }

    function renderModalTable(data) {
        const tbody = document.getElementById('modal-table-body'); tbody.innerHTML = "";
        data.forEach(d => {
            tbody.innerHTML += `<tr id="modal-tr-${d.id}">
                <td>${d.clave}</td>
                <td>${d.numero}</td>
                <td style="display:flex; gap:5px; justify-content:center;">
                    <button class="btn-del-row" style="background:#c0392b;" onclick="deleteFromModal('${d.id}', 'CANCELADA')">üî¥ CANCEL</button>
                    <button class="btn-del-row" style="background:#f39c12;" onclick="deleteFromModal('${d.id}', 'RECOGIDA')">üü† RECOG</button>
                </td>
            </tr>`;
        });
    }

    window.deleteFromModal = async (id, reason) => {
        if(!confirm(`¬øMarcar como ${reason}?`)) return;
        const row = document.getElementById(`modal-tr-${id}`);
        row.style.opacity = '0.5';
        
        try {
            // Log first
            const card = allCardsCache.find(c => c.id === id);
            if(card) await registrarLog(card.zona, card.clave, card.numero, reason);

            await deleteDoc(doc(db, "tarjetas_fisicas", id));
            allCardsCache = allCardsCache.filter(c => c.id !== id);
            row.remove();
            
            toDeleteCount--; totalSys--;
            document.getElementById('cards-to-delete-count').innerText = toDeleteCount;
            document.getElementById('total-sys').innerText = totalSys;
            
            // Sync with main table if loaded
            const mainRow = document.getElementById(`tr-${id}`);
            if(mainRow) mainRow.remove();

            if(toDeleteCount <= 0) { alert("‚úÖ ¬°Conciliaci√≥n Completada!"); closeConciliacion(); calc(); }
        } catch(e) { alert("Error: " + e.message); row.style.opacity = '1'; }
    }

    // --- VER HISTORIAL LOGS ---
    window.openHistory = async () => {
        document.getElementById('historyModal').style.display = 'flex';
        const z = document.getElementById('zonaSelect').value;
        const q = query(collection(db, "historial_tarjetas"), where("zona", "==", z));
        const snap = await getDocs(q);
        
        let logs = [];
        snap.forEach(doc => logs.push(doc.data()));
        // Ordenar en JS para evitar bloqueo de indice
        logs.sort((a,b) => b.fecha.seconds - a.fecha.seconds);
        
        const tbody = document.getElementById('history-table-body'); tbody.innerHTML = "";
        logs.forEach(d => {
            let color = 'black';
            if(d.accion === 'NUEVA') color = 'green';
            if(d.accion === 'CANCELADA') color = 'red';
            if(d.accion === 'RECOGIDA') color = 'orange';
            
            tbody.innerHTML += `<tr>
                <td>${d.fecha.toDate().toLocaleString()}</td>
                <td>${d.clave} - ${d.numero}</td>
                <td style="color:${color}; font-weight:bold;">${d.accion}</td>
                <td>${d.usuario}</td>
            </tr>`;
        });
    }
    window.closeHistory = () => { document.getElementById('historyModal').style.display = 'none'; }

    // --- LIQUIDACI√ìN ---
    window.nav = (p) => { 
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); 
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); 
        if(document.getElementById('view-'+p)) document.getElementById('view-'+p).classList.add('active');
        if(p === 'stats') loadAdminStats();
    };
    
    document.getElementById('zonaSelect').addEventListener('change', ()=>{ 
        const activeView = document.querySelector('.view-section.active').id;
        if(currentUser.role==='cobrador') cargarDash(); 
        else if (activeView === 'view-stats') loadAdminStats();
        else cargarDatos(); 
    });

    window.addTal = () => { document.getElementById('lista-talonarios').insertAdjacentHTML('beforeend', `<div class="item-container"><div class="dynamic-row"><div style="flex:1"><span class="lbl-small">#Tal</span><input class="tal-id"></div><div style="flex:1"><span class="lbl-small">Del</span><input type="number" class="tal-del" oninput="updRow(this)"></div><div style="flex:1"><span class="lbl-small">Al</span><input type="number" class="tal-al" oninput="updRow(this)"></div><div style="flex:1"><span class="lbl-small">Max</span><input type="number" class="tal-max" value="50" oninput="updRow(this)"></div></div><div class="dynamic-row"><div style="flex:2"><span class="lbl-small">Monto L.</span><input type="number" class="monto-tal" oninput="calc()"></div><button class="btn-del" onclick="this.parentElement.parentElement.remove();calc()">X</button></div><div class="lbl-small row-inf"></div></div>`); }
    window.addGas = () => { document.getElementById('lista-gastos').insertAdjacentHTML('beforeend', `<div class="dynamic-row item-gas"><input class="desc-gas" placeholder="Descripci√≥n" style="flex:2"><input type="number" class="monto-gas" placeholder="L." style="flex:1" oninput="calc()"><button class="btn-del" onclick="this.parentElement.remove();calc()">X</button></div>`); }
    window.addBan = () => { document.getElementById('lista-banco').insertAdjacentHTML('beforeend', `<div class="item-container item-ban"><div class="dynamic-row"><select class="b-banc" style="flex:1"><option>Atl√°ntida</option><option>BAC</option><option>Occidente</option><option>Ficohsa</option><option>Banpais</option></select><select class="b-cta" style="flex:1"><option>Jose Rodinder Guardado</option><option>Angel David Guardado</option></select></div><div class="dynamic-row"><div style="flex:1"><span class="lbl-small">Ref/Voucher</span><input class="b-ref"></div><div style="flex:1"><span class="lbl-small">Fecha</span><input type="date" class="b-date"></div></div><div class="dynamic-row"><div style="flex:2"><span class="lbl-small">Monto L.</span><input type="number" class="monto-ban" oninput="calc()"></div><button class="btn-del" onclick="this.parentElement.parentElement.remove();calc()">X</button></div></div>`); }

    window.updRow = (el) => {
        const p = el.closest('.item-container');
        let del=parseInt(p.querySelector('.tal-del').value)||0, al=parseInt(p.querySelector('.tal-al').value)||0;
        if(del>0 && al>=del) { p.querySelector('.row-inf').innerHTML = `Usados: <b>${al-del+1}</b>`; }
        calc();
    };

    window.procPic = (inp, divId) => {
        if(inp.files.length) Array.from(inp.files).forEach(f=>{ let r=new FileReader(); r.onload=(e)=>{ document.getElementById(divId).innerHTML+=`<div class="thumb"><img src="${e.target.result}"><button class="thumb-x" onclick="this.parentElement.remove()">X</button></div>`; }; r.readAsDataURL(f); }); inp.value='';
    };

    window.calc = () => {
        let r=0, g=0, b=0, tarjetasCobradas=0;
        document.querySelectorAll('.item-container').forEach(el => {
            if(el.querySelector('.tal-del')) {
                let m = parseFloat(el.querySelector('.monto-tal').value)||0; r+=m;
                let d = parseInt(el.querySelector('.tal-del').value)||0, a = parseInt(el.querySelector('.tal-al').value)||0;
                if(a>=d) tarjetasCobradas += (a-d+1);
            }
        });
        document.querySelectorAll('.monto-gas').forEach(i=>g+=parseFloat(i.value)||0);
        document.querySelectorAll('.monto-ban').forEach(i=>b+=parseFloat(i.value)||0);
        let c = r * 0.10; let n = r - c - g - b;

        ['lbl_tal','res_ing'].forEach(id=>document.getElementById(id).innerText="L. "+r.toFixed(2));
        ['lbl_gas','res_gas'].forEach(id=>document.getElementById(id).innerText="L. "+g.toFixed(2));
        ['lbl_ban','res_ban'].forEach(id=>document.getElementById(id).innerText="L. "+b.toFixed(2));
        document.getElementById('res_com').innerText="L. "+c.toFixed(2);
        ['res_neto'].forEach(id=>document.getElementById(id).innerText="L. "+n.toFixed(2));

        if(totalSys > 0) {
            let eff = Math.round((tarjetasCobradas / totalSys) * 100);
            document.getElementById('eff-text').innerText = `Cobraste ${tarjetasCobradas} de ${totalSys} (${eff}%)`;
            document.getElementById('eff-bar').style.width = eff + "%";
            document.getElementById('eff-bar').style.background = eff < 50 ? "#c0392b" : (eff < 80 ? "#f39c12" : "#27ae60");
        }

        if(document.getElementById('inv-fis')) {
            let nw=parseInt(document.getElementById('inv-new').value)||0, bj=parseInt(document.getElementById('inv-baj').value)||0, rec=parseInt(document.getElementById('inv-rec').value)||0, fi=document.getElementById('inv-fis').value;
            toDeleteCount = bj + rec;
            const btnContainer = document.getElementById('btn-conciliacion-container');
            if(toDeleteCount > 0) {
                btnContainer.style.display = 'block';
                document.getElementById('count-to-delete').innerText = toDeleteCount;
            } else {
                btnContainer.style.display = 'none';
            }
            if(fi!=="") {
                let teo = totalSys + nw - bj - rec;
                let dif = parseInt(fi) - teo;
                document.getElementById('inv-msg').innerHTML = dif===0 ? "‚úÖ CUADRADO" : `<span style='color:red'>‚ö†Ô∏è DIFERENCIA: ${dif}</span>`;
            }
        }
        return {r,c,g,b,n, cobradas: tarjetasCobradas};
    };

    ['inv-new','inv-baj','inv-rec','inv-fis'].forEach(id=>{if(document.getElementById(id)) document.getElementById(id).addEventListener('input',calc)});

    // --- VISTA PREVIA (AUTO-BAJAS INTELIGENTE + EDICION) ---
    window.abrirVistaPrevia = async () => {
        const c = calc();
        document.getElementById('p-zona').innerText = document.getElementById('zonaSelect').value;
        document.getElementById('p-semana-title').innerText = (document.getElementById('txt_semana').value || "LIQUIDACI√ìN").toUpperCase();
        document.getElementById('p-fecha').innerText = document.getElementById('fecha_liquidacion').value;
        
        document.getElementById('p-rec').innerText = "L. "+c.r.toFixed(2);
        document.getElementById('p-com').innerText = "L. "+c.c.toFixed(2);
        document.getElementById('p-gas').innerText = "L. "+c.g.toFixed(2);
        document.getElementById('p-ban').innerText = "L. "+c.b.toFixed(2);
        document.getElementById('p-neto').innerText = "L. "+c.n.toFixed(2);

        const tbT = document.getElementById('p-tbl-tal'); tbT.innerHTML="<tr><th>#Tal</th><th>Rango</th><th style='text-align:right'>Monto</th></tr>";
        document.querySelectorAll('#lista-talonarios .item-container').forEach(d=>{ tbT.innerHTML+=`<tr><td>${d.querySelector('.tal-id').value}</td><td>${d.querySelector('.tal-del').value}-${d.querySelector('.tal-al').value}</td><td style='text-align:right'>L. ${d.querySelector('.monto-tal').value}</td></tr>`; });
        const tbG = document.getElementById('p-tbl-gas'); tbG.innerHTML="<tr><th>Descripci√≥n</th><th style='text-align:right'>Monto</th></tr>";
        document.querySelectorAll('#lista-gastos .dynamic-row').forEach(d=>{ tbG.innerHTML+=`<tr><td>${d.querySelector('.desc-gas').value}</td><td style='text-align:right'>L. ${d.querySelector('.monto-gas').value}</td></tr>`; });
        const tbB = document.getElementById('p-tbl-ban'); tbB.innerHTML="<tr><th>Banco / Cuenta / Ref</th><th>Fecha</th><th style='text-align:right'>Monto</th></tr>";
        document.querySelectorAll('#lista-banco .item-container').forEach(d=>{ let info = `${d.querySelector('.b-banc').value}<br>${d.querySelector('.b-cta').value}<br>Ref: ${d.querySelector('.b-ref').value}`; tbB.innerHTML+=`<tr><td>${info}</td><td>${d.querySelector('.b-date').value}</td><td style='text-align:right'>L. ${d.querySelector('.monto-ban').value}</td></tr>`; });

        document.getElementById('p-cob').innerText = c.cobradas;
        document.getElementById('p-tot').innerText = totalSys;
        document.getElementById('p-nocob').innerText = (totalSys - c.cobradas);

        // GRID COMPACTO DE BAJAS
        const z = document.getElementById('zonaSelect').value;
        const qH = query(collection(db, "historial_tarjetas"), where("zona", "==", z));
        const sH = await getDocs(qH);
        
        let bajas = [];
        let seenCards = new Set(); 
        const cutDate = new Date(document.getElementById('fecha_liquidacion').value);
        cutDate.setDate(cutDate.getDate() - 7);
        
        sH.forEach(doc => {
            const d = doc.data();
            const fechaMov = d.fecha.toDate();
            if(fechaMov >= cutDate && (d.accion === 'CANCELADA' || d.accion === 'RECOGIDA')) {
                if (!seenCards.has(d.numero)) {
                    bajas.push(d);
                    seenCards.add(d.numero);
                }
            }
        });

        const gridBajas = document.getElementById('p-grid-bajas'); 
        gridBajas.innerHTML = "";
        
        if(bajas.length > 0) {
            bajas.forEach(b => {
                gridBajas.innerHTML += `<div class="baja-item-pdf">
                    <strong>#${b.numero}</strong><br>
                    ${b.accion.substring(0,4)}
                    <button class="btn-remove-pdf" onclick="this.parentElement.remove()">X</button>
                </div>`;
            });
        } else {
            gridBajas.innerHTML = `<div style="grid-column: span 4; text-align:center;">- Ninguna -</div>`;
        }

        let nw=parseInt(document.getElementById('inv-new').value)||0, baj=parseInt(document.getElementById('inv-baj').value)||0, rec=parseInt(document.getElementById('inv-rec').value)||0, fi=document.getElementById('inv-fis').value;
        let teo = totalSys + nw - baj - rec;
        document.getElementById('p-sys').innerText=totalSys; document.getElementById('p-new').innerText=nw; document.getElementById('p-baj').innerText=baj; document.getElementById('p-recog').innerText=rec;
        document.getElementById('p-teo').innerText=teo; document.getElementById('p-fis').innerText=fi;
        document.getElementById('p-msg').innerText=document.getElementById('inv-msg').innerText;

        const pg = document.getElementById('p-gal-gas'); pg.innerHTML="";
        document.querySelectorAll('#gal-gas img').forEach(i=>{ pg.innerHTML+=`<div class="pdf-evidence-block"><div class="pdf-evidence-label">GASTO</div><div class="pdf-image-container"><img src="${i.src}"></div></div>`; });
        const pb = document.getElementById('p-gal-ban'); pb.innerHTML="";
        document.querySelectorAll('#gal-ban img').forEach(i=>{ pb.innerHTML+=`<div class="pdf-evidence-block"><div class="pdf-evidence-label">DEPOSITO</div><div class="pdf-image-container"><img src="${i.src}"></div></div>`; });

        document.getElementById('app-container').style.display = 'none';
        document.getElementById('seccion-impresion').style.display = 'block';
        document.getElementById('printControls').style.display = 'flex';
    };

    window.cerrarVistaPrevia = () => {
        document.getElementById('seccion-impresion').style.display = 'none';
        document.getElementById('printControls').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
    }

    window.saveData = async () => {
        if(!confirm("¬øGuardar liquidaci√≥n?")) return;
        const c=calc(); 
        const fi = parseInt(document.getElementById('inv-fis').value)||0;
        await addDoc(collection(db, "historial_cortes"), {
            fecha: new Date(document.getElementById('fecha_liquidacion').value+'T12:00:00'),
            zona: document.getElementById('zonaSelect').value,
            recaudado: c.r, comision: c.c, gastos: c.g, depositos: c.b, neto: c.n,
            inv_fisico: fi, semana: document.getElementById('txt_semana').value, usuario: currentUser.username,
            tarjetas_cobradas: c.cobradas, total_ruta: totalSys
        });
        alert("‚úÖ Datos guardados.");
    };

    // --- OTHER FUNCS ---
    window.uploadCSV=()=>{ const f=document.getElementById('csvInput').files[0]; if(!f)return; const showLoading = document.getElementById('loading-overlay'); showLoading.style.display = 'flex'; const r=new FileReader(); r.onload=async(e)=>{ const l=e.target.result.split('\n'); let c=0; 
        const z = document.getElementById('zonaSelect').value;
        const q = query(collection(db,"tarjetas_fisicas"), where("zona","==",z));
        const snap = await getDocs(q);
        let existingKeys = new Set();
        snap.forEach(d => existingKeys.add(d.data().clave));

        const batchChunks = [];
        let currentBatch = writeBatch(db);
        let batchCount = 0;

        for(let lin of l){ 
            let p=lin.includes(';')?lin.split(';'):lin.split(','); 
            if(p.length>=2){ 
                let k=p[0].replace(/"/g,'').trim(), n=p[1].replace(/"/g,'').trim(); 
                if(k&&n && !existingKeys.has(k)){ 
                    const ref = doc(collection(db, "tarjetas_fisicas"));
                    currentBatch.set(ref, {zona:z,clave:k,numero:n});
                    
                    // Log separado para evitar batch limit overflow
                    await registrarLog(z,k,n,'NUEVA'); 
                    
                    c++; batchCount++;
                    if(batchCount >= 400) {
                        batchChunks.push(currentBatch.commit());
                        currentBatch = writeBatch(db);
                        batchCount = 0;
                    }
                } 
            } 
        } 
        if(batchCount > 0) batchChunks.push(currentBatch.commit());
        
        await Promise.all(batchChunks);
        showLoading.style.display = 'none';
        alert(`‚úÖ ${c} Tarjetas nuevas subidas.`); 
        cargarDatos(); 
    }; r.readAsText(f); };

    window.crearUsuario = async () => { const u=document.getElementById('new-user').value, p=document.getElementById('new-pass').value, r=document.getElementById('new-role').value; let z=[]; document.querySelectorAll('#zones-checkboxes input:checked').forEach(c=>z.push(c.value)); if(!u || !p) return alert("Faltan datos"); await addDoc(collection(db, "usuarios"), { username:u, password:p, role:r, zones:z }); alert("Creado"); loadUsers(); };
    async function loadUsers(){ const s=await getDocs(collection(db,"usuarios")); let h=""; s.forEach(d=>h+=`<div>${d.data().username} <button onclick="delUser('${d.id}')">X</button></div>`); document.getElementById('lista-usuarios').innerHTML=h; }
    window.delUser=async(id)=>{ if(confirm("Borrar?")) await deleteDoc(doc(db,"usuarios",id)); loadUsers(); };
    window.loadAdminStats = async () => { const z = document.getElementById('zonaSelect').value; document.getElementById('stat-zona-title').innerText = z; const q = query(collection(db, "historial_cortes"), where("zona", "==", z), orderBy("fecha", "asc")); const snap = await getDocs(q); let l=[], d=[], tHTML=""; snap.forEach(doc => { const data = doc.data(); const date = data.fecha.toDate().toLocaleDateString('es-HN'); l.push(date); d.push(data.recaudado); tHTML += `<tr><td>${date}</td><td>${data.semana||'-'}</td><td>L. ${data.recaudado}</td><td>L. ${data.comision}</td><td>L. ${data.neto}</td></tr>`; }); document.getElementById('admin-stats-body').innerHTML = tHTML; if(adminChartInst) adminChartInst.destroy(); adminChartInst = new Chart(document.getElementById('adminChart'), { type:'line', data:{labels:l, datasets:[{label:'Tendencia Recaudo', data:d, borderColor:'#e74c3c', tension:0.3}]} }); }
    window.cargarDash = async () => { const z = document.getElementById('zonaSelect').value; const dStart = document.getElementById('dash-start').value; const dEnd = document.getElementById('dash-end').value; document.getElementById('dash-zona').innerText = z; document.getElementById('dash-name').innerText = currentUser.username; const qT = query(collection(db, "tarjetas_fisicas"), where("zona", "==", z)); const sT = await getDocs(qT); const currentRouteCards = sT.size; const start = new Date(dStart + "T00:00:00"); const end = new Date(dEnd + "T23:59:59"); const qH = query(collection(db, "historial_cortes"), where("zona", "==", z), where("fecha", ">=", start), where("fecha", "<=", end), orderBy("fecha", "asc")); const sH = await getDocs(qH); let l=[], d=[], totRec=0, totCom=0, totCob=0; sH.forEach(o=>{ const dt=o.data(); l.push(dt.fecha.toDate().toLocaleDateString('es-HN',{day:'numeric',month:'short'})); d.push(dt.recaudado); totRec+=dt.recaudado||0; totCom+=dt.comision||0; totCob+=dt.tarjetas_cobradas||0; }); document.getElementById('kpi-recaudo').innerText="L. "+totRec.toLocaleString(); document.getElementById('kpi-com').innerText="L. "+totCom.toLocaleString(); document.getElementById('kpi-cobradas').innerText = `${totCob} / ${currentRouteCards}`; if(chartInst) chartInst.destroy(); chartInst = new Chart(document.getElementById('chartUser'), { type:'line', data:{labels:l, datasets:[{label:'Recaudo', data:d, borderColor:'#2980b9', tension:0.3}]} }); }
</script>
</body>
</html>
