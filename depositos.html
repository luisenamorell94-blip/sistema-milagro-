<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comercial El Milagro - Sistema v3.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --primary: #004d40; --secondary: #00796b; --field-color: #e65100;
            --edit: #1976d2; --error: #d32f2f;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding-bottom: 60px;}
        header { background-color: var(--primary); color: white; padding: 10px; text-align: center; }
        .version-tag { background: red; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        
        .container { max-width: 950px; margin: 0 auto; padding: 10px; }
        
        /* TABS */
        .tabs { display: flex; cursor: pointer; }
        .tab { flex: 1; padding: 15px; text-align: center; font-weight: bold; background: #ccc; color: #555; border-radius: 10px 10px 0 0; }
        .tab.active { background: white; color: var(--primary); border-bottom: 3px solid var(--primary); }
        .tab.active-campo { background: white; color: var(--field-color); border-bottom: 3px solid var(--field-color); }

        .card { background: white; padding: 20px; border-radius: 0 0 10px 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .full-width { grid-column: span 3; }
        
        select, input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        label { font-size: 0.8rem; font-weight: bold; color: #555; display: block; margin-top: 5px;}

        /* BOTONES */
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn-save { flex: 1; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color: white; }
        .btn-oficina { background-color: var(--secondary); }
        .btn-campo { background-color: var(--field-color); }
        
        .btn-actualizar { background-color: var(--edit) !important; animation: parpadeo 2s infinite; }
        .btn-cancelar { background-color: #757575; color: white; border: none; padding: 12px; border-radius: 5px; font-weight: bold; cursor: pointer; display: none; }
        @keyframes parpadeo { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        /* TABLA Y BOTONES DE ACCI√ìN */
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th, td { padding: 6px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f0f0f0; }
        
        .btn-action { border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 1rem; margin-right: 5px; }
        .btn-edit { background: #e3f2fd; color: var(--edit); } 
        .btn-delete { background: #ffebee; color: var(--error); }

        /* Reportes */
        .report-section { background: white; border-radius: 8px; padding: 10px; margin-bottom: 15px; border-top: 5px solid #555; }
        .border-david { border-top-color: #0d47a1; }
        .border-lesly { border-top-color: #880e4f; }
        .border-jose { border-top-color: #1b5e20; }
        .border-mix { border-top-color: #4a148c; }
        
        .account-title { margin: 0; padding-bottom: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        
        #status-bar { text-align: center; padding: 5px; font-size: 0.8rem; background: #333; color: white; }
        .online { background: #2e7d32 !important; }

        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } .full-width { grid-column: span 1; } }
        @media print { .no-print, .tabs, .card, #status-bar { display: none !important; } body { background: white; } }
    </style>
</head>
<body>

<div id="status-bar">Conectando...</div>

<header>
    <h1>COMERCIAL EL MILAGRO</h1>
    <span class="version-tag">VERSI√ìN 3.0 (CON EDICI√ìN)</span>
</header>

<div class="container">
    <div class="tabs">
        <div class="tab active" id="tab-btn-oficina" onclick="setModo('OFICINA')">üè¢ OFICINA</div>
        <div class="tab" id="tab-btn-campo" onclick="setModo('CAMPO')">üèçÔ∏è VENDEDORES</div>
    </div>

    <div class="card">
        <div class="form-grid">
            <div><label>Semana</label><select id="semana"><option>Semana 1</option><option>Semana 2</option><option>Semana 3</option><option>Semana 4</option><option>Semana 5</option></select></div>
            <div><label>Fecha</label><input type="date" id="fecha"></div>
            <div><label>Referencia</label><input type="number" id="referencia"></div>
            <div class="full-width"><label>Zona</label><select id="zona" onchange="autoCobrador()"></select></div>
            <div class="full-width"><label>Cobrador</label><input type="text" id="cobrador" readonly style="background:#eee;"></div>
            <div class="full-width"><label>Cuenta</label><select id="cuenta"></select></div>
            <div class="full-width"><label>Monto</label><input type="number" id="monto"></div>
        </div>
        <div class="btn-group">
            <button id="btn-cancelar" class="btn-cancelar" onclick="cancelar()">CANCELAR</button>
            <button id="btn-save" class="btn-save btn-oficina" onclick="guardar()">GUARDAR EN NUBE</button>
        </div>
    </div>

    <div id="reportes"></div>
    <div style="background:#222; color:white; padding:10px; text-align:right; font-weight:bold; margin-top:10px;">TOTAL: <span id="gran-total">L. 0.00</span></div>
    
    <br>
    <button onclick="window.print()" class="btn-save no-print" style="background:#d32f2f;">üìÑ IMPRIMIR PDF</button>
</div>

<script>
    // --- 1. CONFIGURACI√ìN FIREBASE (CL√ÅSICA) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAYJRmMQbV-j6hGfHCZyuCgtvmkY0C2L1g",
      authDomain: "ingreso-depositos.firebaseapp.com",
      databaseURL: "https://ingreso-depositos-default-rtdb.firebaseio.com",
      projectId: "ingreso-depositos",
      storageBucket: "ingreso-depositos.firebasestorage.app",
      messagingSenderId: "788432921819",
      appId: "1:788432921819:web:b5f792eecbe4b7b00498fe"
    };
    
    // Inicializar directo (sin m√≥dulos)
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const refMilagro = db.ref('registros_milagro');

    // --- 2. VARIABLES Y DATOS ---
    let registros = [];
    let MODO = 'OFICINA';
    let ID_EDITANDO = null;

    const rutas = {
        "MIGUEL": ["Elixir", "Saba Olanchito", "Zona Saba"],
        "ANGEL": ["Margen Izquierda", "Saba Tocoa"],
        "FERNANDO": ["Vicinia", "Trujillo", "Honduras Aguan"],
        "AMALET": ["Balfate", "Bonito Oriental"],
        "JORGE": ["Planes", "Jutiapa", "Sonaguera", "Faust"]
    };

    // --- 3. INICIO ---
    window.onload = function() {
        document.getElementById('fecha').valueAsDate = new Date();
        llenarSelects();
        setModo('OFICINA');
        
        // Escuchar Firebase
        refMilagro.on('value', (snapshot) => {
            const data = snapshot.val();
            registros = [];
            if(data) {
                Object.keys(data).forEach(k => registros.push({ id: k, ...data[k] }));
            }
            pintarTabla();
            document.getElementById('status-bar').innerText = "üü¢ CONECTADO (v3.0)";
            document.getElementById('status-bar').classList.add('online');
        });
    };

    // --- 4. FUNCIONES LOGICAS ---
    window.guardar = function() {
        const data = {
            origen: MODO,
            semana: getValue('semana'),
            fecha: getValue('fecha'),
            ref: getValue('referencia'),
            zona: getValue('zona'),
            cobrador: getValue('cobrador'),
            cuenta: getValue('cuenta'),
            monto: parseFloat(getValue('monto'))
        };

        if(!data.zona || !data.cobrador || !data.ref || isNaN(data.monto)) {
            alert("‚ö†Ô∏è Faltan datos"); return;
        }

        if(ID_EDITANDO) {
            // ACTUALIZAR
            db.ref('registros_milagro/' + ID_EDITANDO).update(data)
            .then(() => { alert("‚úÖ Editado"); cancelar(); });
        } else {
            // NUEVO
            const existe = registros.find(r => r.ref == data.ref);
            if(existe) { alert("‚õî Referencia Repetida"); return; }
            
            refMilagro.push(data).then(() => {
                document.getElementById('referencia').value = "";
                document.getElementById('monto').value = "";
                document.getElementById('referencia').focus();
            });
        }
    };

    window.borrar = function(id) {
        if(confirm("¬øEliminar registro?")) db.ref('registros_milagro/' + id).remove();
    };

    window.editar = function(id) {
        const r = registros.find(x => x.id === id);
        if(!r) return;
        
        setModo(r.origen);
        
        document.getElementById('semana').value = r.semana;
        document.getElementById('fecha').value = r.fecha;
        document.getElementById('referencia').value = r.ref;
        document.getElementById('zona').value = r.zona;
        document.getElementById('cobrador').value = r.cobrador;
        document.getElementById('cuenta').value = r.cuenta;
        document.getElementById('monto').value = r.monto;

        ID_EDITANDO = id;
        
        // Cambio visual
        const btn = document.getElementById('btn-save');
        btn.innerText = "ACTUALIZAR REGISTRO";
        btn.classList.add('btn-actualizar');
        document.getElementById('btn-cancelar').style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.cancelar = function() {
        ID_EDITANDO = null;
        document.getElementById('referencia').value = "";
        document.getElementById('monto').value = "";
        document.getElementById('btn-cancelar').style.display = 'none';
        const btn = document.getElementById('btn-save');
        btn.innerText = MODO === 'OFICINA' ? "GUARDAR EN NUBE" : "SUBIR BAUCHER";
        btn.classList.remove('btn-actualizar');
    };

    // --- 5. UI HELPER FUNCTIONS ---
    function getValue(id) { return document.getElementById(id).value; }

    window.setModo = function(m) {
        MODO = m;
        const btn = document.getElementById('btn-save');
        const tabO = document.getElementById('tab-btn-oficina');
        const tabC = document.getElementById('tab-btn-campo');
        
        tabO.className = m === 'OFICINA' ? 'tab active' : 'tab';
        tabC.className = m === 'CAMPO' ? 'tab active-campo' : 'tab';
        
        btn.className = m === 'OFICINA' ? 'btn-save btn-oficina' : 'btn-save btn-campo';
        if(!ID_EDITANDO) btn.innerText = m === 'OFICINA' ? "GUARDAR EN NUBE" : "SUBIR BAUCHER";
        
        llenarCuentas();
    };

    window.autoCobrador = function() {
        const z = document.getElementById('zona');
        const opt = z.options[z.selectedIndex];
        document.getElementById('cobrador').value = opt.getAttribute('data-c') || "";
    };

    function llenarSelects() {
        const z = document.getElementById('zona');
        for (const [cob, list] of Object.entries(rutas)) {
            const g = document.createElement('optgroup'); g.label = cob;
            list.forEach(l => {
                const o = document.createElement('option');
                o.value = l; o.innerText = l; o.setAttribute('data-c', cob);
                g.appendChild(o);
            });
            z.appendChild(g);
        }
    }

    function llenarCuentas() {
        const c = document.getElementById('cuenta');
        const old = c.value;
        c.innerHTML = "";
        if(MODO === 'OFICINA') {
            c.innerHTML = "<option value='LESLY'>üè¶ CUENTA LESLY</option>";
        } else {
            c.innerHTML = "<option value='DAVID'>üè¶ CUENTA DAVID</option><option value='DAVID_LESLY'>üè¶ DAVID (VIA LESLY)</option><option value='JOSE_RODINDER'>üè¶ JOSE RODINDER</option>";
        }
        c.value = old;
    }

    // --- 6. PINTAR TABLA (EL CORAZ√ìN DEL SISTEMA) ---
    function pintarTabla() {
        const div = document.getElementById('reportes');
        div.innerHTML = "";
        let total = 0;

        const grupos = {
            "DAVID": { t: "CUENTA DAVID", c: "border-david" },
            "LESLY": { t: "CUENTA LESLY", c: "border-lesly" },
            "DAVID_LESLY": { t: "DAVID (VIA LESLY)", c: "border-mix" },
            "JOSE_RODINDER": { t: "JOSE RODINDER", c: "border-jose" }
        };

        for (const [key, conf] of Object.entries(grupos)) {
            const list = registros.filter(r => r.cuenta === key);
            if(list.length > 0) {
                let sub = 0;
                let rows = "";
                
                // Ordenar por fecha
                list.sort((a,b) => new Date(a.fecha) - new Date(b.fecha));

                list.forEach(r => {
                    sub += r.monto;
                    rows += `<tr>
                        <td>${r.zona}</td>
                        <td>${r.cobrador}</td>
                        <td>${r.ref}</td>
                        <td>L. ${r.monto.toLocaleString()}</td>
                        <td class="no-print">
                            <button class="btn-action btn-edit" onclick="editar('${r.id}')">‚úèÔ∏è</button>
                            <button class="btn-action btn-delete" onclick="borrar('${r.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                total += sub;

                div.innerHTML += `
                <div class="report-section ${conf.c}">
                    <h3 class="account-title">${conf.t} <span>L. ${sub.toLocaleString()}</span></h3>
                    <table>
                        <thead><tr><th>Zona</th><th>Cobrador</th><th>Ref</th><th>Monto</th><th class="no-print">Acci√≥n</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;
            }
        }
        document.getElementById('gran-total').innerText = "L. " + total.toLocaleString();
    }
</script>

</body>
</html>
