<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comercial El Milagro - Sistema Cloud</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { 
            --primary: #004d40; --secondary: #00796b; --field-color: #e65100;
            --light: #e0f2f1; --accent: #ffd600; --error: #d32f2f; --edit: #1976d2;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; padding-bottom: 60px;}
        header { background-color: var(--primary); color: white; padding: 15px; text-align: center; }
        .container { max-width: 950px; margin: 0 auto; padding: 15px; }
        
        /* TABS */
        .tabs { display: flex; cursor: pointer; }
        .tab { flex: 1; padding: 15px; text-align: center; font-weight: bold; background: #ccc; color: #555; border-radius: 10px 10px 0 0; transition: 0.3s; }
        .tab.active { background: white; color: var(--primary); border-bottom: 3px solid var(--primary); }
        .tab.active-campo { background: white; color: var(--field-color); border-bottom: 3px solid var(--field-color); }

        .card { background: white; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 0 0 10px 10px; }
        .mode-indicator { text-align: center; padding: 10px; margin-bottom: 15px; border-radius: 5px; font-weight: bold; }
        .mode-oficina { background: #e0f2f1; color: var(--primary); border: 1px solid var(--primary); }
        .mode-campo { background: #fff3e0; color: var(--field-color); border: 1px solid var(--field-color); }
        .mode-editando { background: #e3f2fd; color: var(--edit); border: 2px dashed var(--edit); }

        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .full-width { grid-column: span 3; }
        label { display: block; font-size: 0.85rem; font-weight: bold; color: #555; margin-bottom: 5px; }
        select, input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn-save { flex: 1; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color: white; transition: 0.3s; }
        .btn-oficina { background-color: var(--secondary); }
        .btn-oficina:hover { background-color: var(--primary); }
        .btn-campo { background-color: var(--field-color); }
        .btn-campo:hover { background-color: #bf360c; }
        
        .btn-actualizar { background-color: var(--edit) !important; animation: parpadeo 2s infinite; }
        .btn-cancelar { background-color: #757575; color: white; border: none; padding: 12px; border-radius: 5px; font-weight: bold; cursor: pointer; display: none; }
        
        @keyframes parpadeo { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        /* REPORTE */
        .report-section { background: white; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-top: 5px solid #555; page-break-inside: avoid; }
        .border-david { border-top-color: #0d47a1; }
        .border-lesly { border-top-color: #880e4f; }
        .border-jose { border-top-color: #1b5e20; }
        .border-mix { border-top-color: #4a148c; }
        
        .account-title { margin: 0 0 10px 0; font-size: 1.1rem; color: #333; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 5px;}

        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 6px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f0f0f0; }
        
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; }
        .badge-oficina { background: #e0f2f1; color: var(--primary); border: 1px solid var(--primary); }
        .badge-campo { background: #fff3e0; color: var(--field-color); border: 1px solid var(--field-color); }

        .btn-action { cursor: pointer; padding: 4px 8px; border-radius: 4px; border: none; font-weight: bold; margin-right: 2px; }
        .btn-edit { background: #e3f2fd; color: var(--edit); }
        .btn-delete { background: #ffebee; color: var(--error); }

        .zone-summary-box { background: #fafafa; border: 1px solid #ddd; padding: 8px; margin-top: 8px; font-size: 0.85rem; page-break-inside: avoid; }
        .zone-summary-title { font-weight: bold; margin-bottom: 4px; border-bottom: 1px solid #ccc; }
        .zone-row { display: flex; justify-content: space-between; padding: 2px 0; }
        .zone-total { font-weight: bold; }

        .grand-total-box { background: #222; color: white; padding: 15px; text-align: right; font-size: 1.2rem; margin-top: 20px; font-weight: bold; }

        #status-bar { text-align: center; padding: 5px; font-size: 0.8rem; background: #333; color: white; transition: 0.5s; }
        .online { background: #2e7d32 !important; }

        @media print {
            .tabs, .card, .btn-pdf, header, #status-bar, .no-print { display: none !important; }
            #print-header { display: block !important; text-align: center; border-bottom: 2px solid #333; margin-bottom: 20px; }
            .report-section { box-shadow: none; border: 1px solid #ddd; border-top-width: 5px; }
            body { background: white; }
            .grand-total-box { background-color: #222 !important; color: white !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } .full-width { grid-column: span 1; } }
    </style>
</head>
<body>

<div id="status-bar">Conectando con la Nube... ‚òÅÔ∏è</div>

<header>
    <h1>COMERCIAL EL MILAGRO</h1>
    <h2>Sistema Cloud en Tiempo Real</h2>
</header>

<div class="container">

    <div class="tabs">
        <div class="tab active" id="tab-btn-oficina" onclick="window.cambiarModo('OFICINA')">üè¢ COBRO ADMINISTRACI√ìN</div>
        <div class="tab" id="tab-btn-campo" onclick="window.cambiarModo('CAMPO')">üèçÔ∏è DEP√ìSITOS VENDEDORES</div>
    </div>

    <div class="card">
        <div id="indicador-modo" class="mode-indicator mode-oficina">MODO: DINERO RECIBIDO EN OFICINA</div>
        <div class="form-grid">
            <div><label>Semana:</label><select id="semana">
                <option>Semana 1</option><option>Semana 2</option><option>Semana 3</option><option>Semana 4</option><option>Semana 5</option>
            </select></div>
            <div><label>Fecha:</label><input type="date" id="fecha"></div>
            <div><label>Referencia / Baucher:</label><input type="number" id="referencia" placeholder="Ej. 12345"></div>
            <div class="full-width"><label>Zona:</label><select id="zona" onchange="window.actualizarCobrador()"><option value="">-- Seleccione Zona --</option></select></div>
            <div class="full-width"><label>Cobrador:</label><input type="text" id="cobrador" readonly style="background:#eee;"></div>
            <div class="full-width"><label>Cuenta Destino:</label><select id="cuenta" style="font-weight:bold; color:#004d40;"></select></div>
            <div class="full-width"><label>Monto (L.):</label><input type="number" id="monto" placeholder="0.00"></div>
        </div>
        
        <div class="btn-group">
            <button id="btn-cancelar" class="btn-cancelar" onclick="window.cancelarEdicion()">CANCELAR EDICI√ìN</button>
            <button id="btn-accion" class="btn-save btn-oficina" onclick="window.guardarEnFirebase()">GUARDAR EN LA NUBE</button>
        </div>
    </div>

    <div id="area-de-reporte">
        <div id="print-header" style="display:none;">
            <h2>REPORTE DE COBROS Y DEP√ìSITOS</h2>
            <p>Comercial El Milagro - Sonaguera, Col√≥n</p>
        </div>
        <div id="contenedor-reportes"></div>
        <div class="grand-total-box">TOTAL GLOBAL: <span id="gran-total-display">L. 0.00</span></div>
    </div>

    <div style="margin-top: 20px;">
        <button onclick="window.print()" class="btn-pdf no-print" style="background:#d32f2f; color:white; padding:15px; width:100%; border:none; border-radius:8px; font-weight:bold; font-size:1.1rem; cursor:pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">üìÑ IMPRIMIR / PDF</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- CONFIGURACI√ìN ---
    const firebaseConfig = {
      apiKey: "AIzaSyAYJRmMQbV-j6hGfHCZyuCgtvmkY0C2L1g",
      authDomain: "ingreso-depositos.firebaseapp.com",
      databaseURL: "https://ingreso-depositos-default-rtdb.firebaseio.com",
      projectId: "ingreso-depositos",
      storageBucket: "ingreso-depositos.firebasestorage.app",
      messagingSenderId: "788432921819",
      appId: "1:788432921819:web:b5f792eecbe4b7b00498fe",
      measurementId: "G-2VR37Z1MQL"
    };

    // VARIABLES GLOBALES
    let registrosLocales = [];
    let idEditando = null;
    let MODO_ACTUAL = 'OFICINA';

    const rutas = {
        "MIGUEL": ["Elixir", "Saba Olanchito", "Zona Saba"],
        "ANGEL": ["Margen Izquierda", "Saba Tocoa"],
        "FERNANDO": ["Vicinia", "Trujillo", "Honduras Aguan"],
        "AMALET": ["Balfate", "Bonito Oriental"],
        "JORGE": ["Planes", "Jutiapa", "Sonaguera", "Faust"]
    };
    
    const configCuentas = {
        "DAVID": { titulo: "CUENTA DAVID", color: "border-david" },
        "LESLY": { titulo: "CUENTA LESLY", color: "border-lesly" },
        "DAVID_LESLY": { titulo: "CUENTA DAVID (V√çA LESLY)", color: "border-mix" },
        "JOSE_RODINDER": { titulo: "JOSE RODINDER GUARDADO PINEDA", color: "border-jose" }
    };

    // INICIAR APP
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const registrosRef = ref(db, 'registros_milagro');

    // ESCUCHAR DATOS
    onValue(registrosRef, (snapshot) => {
        const data = snapshot.val();
        registrosLocales = [];
        if (data) {
            Object.keys(data).forEach(key => {
                registrosLocales.push({ idFirebase: key, ...data[key] });
            });
        }
        pintarHTML(registrosLocales);
        
        const status = document.getElementById('status-bar');
        status.innerText = "üü¢ Conectado y Sincronizado";
        status.classList.add('online');
    });

    // --- FUNCIONES L√ìGICAS ---

    function guardarEnFirebase() {
        const semana = document.getElementById('semana').value;
        const fecha = document.getElementById('fecha').value;
        const refNum = document.getElementById('referencia').value.trim();
        const zona = document.getElementById('zona').value;
        const cobrador = document.getElementById('cobrador').value;
        const cuenta = document.getElementById('cuenta').value;
        const monto = parseFloat(document.getElementById('monto').value);

        if (!zona || !cobrador || isNaN(monto) || !refNum) { alert("‚ö†Ô∏è Falta informaci√≥n"); return; }

        // ACTUALIZAR
        if (idEditando) {
            update(ref(db, 'registros_milagro/' + idEditando), {
                origen: MODO_ACTUAL,
                semana, fecha, ref: refNum, zona, cobrador, cuenta, monto
            })
            .then(() => {
                alert("‚úÖ Registro actualizado");
                cancelarEdicion();
            })
            .catch(err => alert("Error: " + err.message));
            return;
        }

        // NUEVO REGISTRO
        const duplicado = registrosLocales.find(r => r.ref === refNum);
        if (duplicado) { 
            alert(`‚õî DUPLICADO: El recibo ${refNum} ya existe en ${duplicado.zona}`); 
            return; 
        }

        push(registrosRef, { origen: MODO_ACTUAL, semana, fecha, ref: refNum, zona, cobrador, cuenta, monto })
        .then(() => {
            document.getElementById('monto').value = "";
            document.getElementById('referencia').value = "";
            document.getElementById('referencia').focus();
        })
        .catch(err => alert("Error: " + err.message));
    }

    function eliminarDeNube(id) {
        if(confirm("‚ö†Ô∏è ¬øEliminar registro permanentemente?")) {
            remove(ref(db, `registros_milagro/${id}`));
        }
    }

    function cargarParaEditar(id) {
        const registro = registrosLocales.find(r => r.idFirebase === id);
        if (!registro) return;

        cambiarModo(registro.origen);

        document.getElementById('semana').value = registro.semana;
        document.getElementById('fecha').value = registro.fecha;
        document.getElementById('referencia').value = registro.ref;
        document.getElementById('zona').value = registro.zona;
        actualizarCobrador();
        document.getElementById('cuenta').value = registro.cuenta;
        document.getElementById('monto').value = registro.monto;

        idEditando = id;
        const btn = document.getElementById('btn-accion');
        btn.innerText = "ACTUALIZAR REGISTRO";
        btn.classList.add('btn-actualizar');
        document.getElementById('btn-cancelar').style.display = 'block';
        document.getElementById('indicador-modo').classList.add('mode-editando');
        document.getElementById('indicador-modo').innerText = "‚úèÔ∏è EDITANDO: " + registro.ref;

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelarEdicion() {
        idEditando = null;
        document.getElementById('monto').value = "";
        document.getElementById('referencia').value = "";
        document.getElementById('btn-cancelar').style.display = 'none';
        
        const btn = document.getElementById('btn-accion');
        btn.classList.remove('btn-actualizar');
        document.getElementById('indicador-modo').classList.remove('mode-editando');
        
        cambiarModo(MODO_ACTUAL);
    }

    // --- FUNCIONES DE INTERFAZ ---

    function cambiarModo(modo) {
        MODO_ACTUAL = modo;
        const tabOficina = document.getElementById('tab-btn-oficina');
        const tabCampo = document.getElementById('tab-btn-campo');
        const indicador = document.getElementById('indicador-modo');
        const boton = document.getElementById('btn-accion');

        tabOficina.className = 'tab'; tabCampo.className = 'tab';
        indicador.className = 'mode-indicator'; boton.className = 'btn-save';

        if (modo === 'OFICINA') {
            tabOficina.classList.add('active');
            indicador.classList.add('mode-oficina'); indicador.innerText = "MODO: OFICINA (SOLO LESLY)";
            boton.classList.add('btn-oficina'); boton.innerText = idEditando ? "ACTUALIZAR REGISTRO" : "GUARDAR EN LA NUBE";
        } else {
            tabCampo.classList.add('active-campo');
            indicador.classList.add('mode-campo'); indicador.innerText = "MODO: VENDEDORES (OTRAS CUENTAS)";
            boton.classList.add('btn-campo'); boton.innerText = idEditando ? "ACTUALIZAR REGISTRO" : "SUBIR BAUCHER A LA NUBE";
        }
        actualizarSelectCuentas();
    }

    function actualizarSelectCuentas() {
        const select = document.getElementById('cuenta');
        const valorActual = select.value;
        select.innerHTML = "";
        if (MODO_ACTUAL === 'OFICINA') {
            select.innerHTML = '<option value="LESLY">üè¶ CAJA / CUENTA LESLY</option>';
        } else {
            select.innerHTML = `
                <option value="DAVID">üè¶ CUENTA DAVID</option>
                <option value="DAVID_LESLY">üè¶ CUENTA DAVID (V√≠a Lesly)</option>
                <option value="JOSE_RODINDER">üè¶ JOSE RODINDER GUARDADO PINEDA</option>
            `;
        }
        if(valorActual) {
             // Verificar si el valor actual existe en las nuevas opciones
             const existe = Array.from(select.options).some(op => op.value === valorActual);
             if(existe) select.value = valorActual;
        }
    }

    function cargarZonasEnSelect() {
        const selectZona = document.getElementById('zona');
        for (const [nombreCobrador, zonas] of Object.entries(rutas)) {
            const grupo = document.createElement('optgroup');
            grupo.label = "Ruta: " + nombreCobrador;
            zonas.forEach(zona => {
                const opt = document.createElement('option');
                opt.value = zona; opt.text = zona; opt.setAttribute('data-cobrador', nombreCobrador);
                grupo.appendChild(opt);
            });
            selectZona.appendChild(grupo);
        }
    }

    function actualizarCobrador() {
        const selectZona = document.getElementById('zona');
        const opcion = selectZona.options[selectZona.selectedIndex];
        document.getElementById('cobrador').value = opcion && opcion.value ? opcion.getAttribute('data-cobrador') : "";
    }

    function pintarHTML(listaRegistros) {
        const contenedor = document.getElementById('contenedor-reportes');
        contenedor.innerHTML = ""; 
        let granTotal = 0;

        if(!listaRegistros || listaRegistros.length === 0) {
            contenedor.innerHTML = "<p style='text-align:center; padding:20px; color:#888;'>No hay datos ingresados a√∫n.</p>";
            document.getElementById('gran-total-display').innerText = "L. 0.00";
            return;
        }

        for (const [claveCuenta, config] of Object.entries(configCuentas)) {
            const registrosCuenta = listaRegistros.filter(r => r.cuenta === claveCuenta);
            
            if (registrosCuenta.length > 0) {
                registrosCuenta.sort((a, b) => a.semana.localeCompare(b.semana) || new Date(a.fecha) - new Date(b.fecha));

                let subtotalCuenta = 0;
                let filasHTML = "";
                let totalesPorZona = {};

                registrosCuenta.forEach(reg => {
                    subtotalCuenta += reg.monto;
                    if (!totalesPorZona[reg.zona]) totalesPorZona[reg.zona] = 0;
                    totalesPorZona[reg.zona] += reg.monto;

                    const badgeClass = reg.origen === 'OFICINA' ? 'badge-oficina' : 'badge-campo';
                    const origenTexto = reg.origen === 'OFICINA' ? 'OFICINA' : 'CAMPO';

                    filasHTML += `
                        <tr>
                            <td><span class="badge ${badgeClass}">${origenTexto}</span></td>
                            <td>${reg.semana}</td>
                            <td>${reg.fecha}</td>
                            <td>${reg.zona}</td>
                            <td>${reg.cobrador}</td>
                            <td>${reg.ref}</td>
                            <td>L. ${reg.monto.toLocaleString('es-HN', {minimumFractionDigits: 2})}</td>
                            <td class="no-print" style="white-space:nowrap; text-align:center;">
                                <button class="btn-action btn-edit" onclick="window.cargarParaEditar('${reg.idFirebase}')" title="Editar">‚úèÔ∏è</button>
                                <button class="btn-action btn-delete" onclick="window.eliminarDeNube('${reg.idFirebase}')" title="Eliminar">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
                granTotal += subtotalCuenta;

                let resumenZonaHTML = `<div class="zone-summary-box"><div class="zone-summary-title">Resumen por Zona (${config.titulo})</div>`;
                Object.keys(totalesPorZona).sort().forEach(zona => {
                    resumenZonaHTML += `
                        <div class="zone-row">
                            <span>${zona}</span>
                            <span class="zone-total">L. ${totalesPorZona[zona].toLocaleString('es-HN', {minimumFractionDigits: 2})}</span>
                        </div>`;
                });
                resumenZonaHTML += `</div>`;

                contenedor.innerHTML += `
                    <div class="report-section ${config.color}">
                        <h3 class="account-title">${config.titulo} <span>L. ${subtotalCuenta.toLocaleString('es-HN', {minimumFractionDigits: 2})}</span></h3>
                        <div style="overflow-x:auto;">
                            <table>
                                <thead><tr><th>Orig.</th><th>Sem.</th><th>Fecha</th><th>Zona</th><th>Cobrador</th><th>Ref.</th><th>Monto</th><th class="no-print">Acci√≥n</th></tr></thead>
                                <tbody>${filasHTML}</tbody>
                            </table>
                        </div>
                        ${resumenZonaHTML}
                    </div>`;
            }
        }
        document.getElementById('gran-total-display').innerText = "L. " + granTotal.toLocaleString('es-HN', {minimumFractionDigits: 2});
    }

    // --- EXPORTAR A WINDOW (ESTO ES CRUCIAL) ---
    // Al usar type="module", las funciones son privadas por defecto.
    // Aqu√≠ las hacemos p√∫blicas para que los botones HTML las vean.
    window.guardarEnFirebase = guardarEnFirebase;
    window.eliminarDeNube = eliminarDeNube;
    window.cargarParaEditar = cargarParaEditar;
    window.cancelarEdicion = cancelarEdicion;
    window.cambiarModo = cambiarModo;
    window.actualizarCobrador = actualizarCobrador;
    
    // INICIALIZAR FORMULARIO
    document.getElementById('fecha').valueAsDate = new Date();
    cargarZonasEnSelect();
    actualizarSelectCuentas();

</script>

</body>
</html>
