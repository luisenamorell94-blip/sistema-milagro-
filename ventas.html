<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA COMPLETO</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { font-family: sans-serif; background: #eef2f5; margin: 0; padding-bottom: 50px; }
        
        /* BARRA SUPERIOR */
        .header-top { background: #4a148c; color: white; text-align: center; padding: 10px; font-weight: bold; }

        .container { max-width: 900px; margin: 0 auto; padding: 15px; }

        /* PESTA√ëAS GRANDES */
        .tabs { display: flex; gap: 5px; margin-bottom: 0; }
        .tab { flex: 1; padding: 15px; text-align: center; font-weight: bold; cursor: pointer; background: #ccc; color: #555; border-radius: 10px 10px 0 0; }
        
        .active-oficina { background: #004d40; color: white; } /* Verde */
        .active-campo { background: #e65100; color: white; }   /* Naranja */
        .active-contado { background: #6200ea; color: white; border-top: 4px solid #b388ff; } /* MORADO - NUEVA */

        .card { background: white; padding: 20px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }

        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        button { width: 100%; padding: 15px; margin-top: 20px; border: none; font-weight: bold; color: white; cursor: pointer; font-size: 1rem; border-radius: 5px; }
        
        /* BOTONES DE COLORES */
        .btn-verde { background: #004d40; }
        .btn-naranja { background: #e65100; }
        .btn-morado { background: #6200ea; } /* COLOR PARA CONTADO */
        .btn-cancelar { background: #d32f2f; display: none; }

        /* SECCIONES OCULTAS */
        .oculto { display: none; }

        /* TABLA */
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; }
        th { background: #eee; padding: 10px; text-align: left; }
        td { border-bottom: 1px solid #ddd; padding: 10px; }
        
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.8rem; font-weight: bold; }
    </style>
</head>
<body>

<div class="header-top">SISTEMA COMPLETO CON CONTADO (v5.0)</div>

<div class="container">

    <div class="tabs">
        <div id="tab-oficina" class="tab active-oficina" onclick="cambiarPestana('OFICINA')">üè¢ OFICINA</div>
        <div id="tab-campo" class="tab" onclick="cambiarPestana('CAMPO')">üèçÔ∏è CAMPO</div>
        <div id="tab-contado" class="tab" onclick="cambiarPestana('CONTADO')">üì¶ VENTAS CONTADO</div>
    </div>

    <div class="card">
        <h3 id="titulo-form" style="text-align:center; margin-top:0; color:#004d40;">INGRESO DE DATOS</h3>

        <label>Fecha:</label>
        <input type="date" id="fecha">

        <div id="seccion-depositos">
            <label>Semana:</label>
            <select id="semana"><option>Semana 1</option><option>Semana 2</option><option>Semana 3</option><option>Semana 4</option><option>Semana 5</option></select>
            
            <label>Referencia:</label>
            <input type="number" id="referencia" placeholder="N√∫mero de recibo">
            
            <label>Zona:</label>
            <select id="zona" onchange="autoCobrador()"></select>
            
            <label>Cobrador:</label>
            <input type="text" id="cobrador" readonly style="background:#eee;">
            
            <label>Cuenta:</label>
            <select id="cuenta"></select>
        </div>

        <div id="seccion-contado" class="oculto">
            <label>Vendedor (Tarjeta):</label>
            <select id="vendedor_contado">
                <option value="">-- Seleccione --</option>
                <option value="SANTOS">SANTOS</option>
                <option value="NOE">NOE</option>
                <option value="CARLOS">CARLOS</option>
                <option value="RAMON">RAMON</option>
                <option value="ORLANDO">ORLANDO</option>
                <option value="DAVID">DAVID</option>
            </select>

            <label>Art√≠culo / Descripci√≥n:</label>
            <input type="text" id="articulo" placeholder="Ej: Estufa, Cama...">
        </div>

        <label id="lbl-monto">Monto (L.):</label>
        <input type="number" id="monto" placeholder="0.00">

        <button id="btn-guardar" class="btn-verde" onclick="guardar()">GUARDAR REGISTRO</button>
        <button id="btn-cancelar" class="btn-cancelar" onclick="cancelar()">CANCELAR EDICI√ìN</button>
    </div>

    <h3 id="titulo-tabla">Registros Recientes</h3>
    <div style="overflow-x:auto;">
        <table>
            <thead id="tabla-head"></thead>
            <tbody id="tabla-body"></tbody>
        </table>
    </div>
    
    <div style="text-align:right; font-size:1.2rem; font-weight:bold; margin-top:20px;">
        TOTAL: <span id="total">L. 0.00</span>
    </div>

</div>

<script>
    // --- CONFIGURACI√ìN FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyAYJRmMQbV-j6hGfHCZyuCgtvmkY0C2L1g",
      authDomain: "ingreso-depositos.firebaseapp.com",
      databaseURL: "https://ingreso-depositos-default-rtdb.firebaseio.com",
      projectId: "ingreso-depositos",
      storageBucket: "ingreso-depositos.firebasestorage.app",
      messagingSenderId: "788432921819",
      appId: "1:788432921819:web:b5f792eecbe4b7b00498fe"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // VARIABLES
    let MODO = 'OFICINA';
    let ID_EDITANDO = null;
    let listaDep = [];
    let listaCon = [];
    
    // RUTAS
    const rutas = {
        "MIGUEL": ["Elixir", "Saba Olanchito", "Zona Saba"],
        "ANGEL": ["Margen Izquierda", "Saba Tocoa"],
        "FERNANDO": ["Vicinia", "Trujillo", "Honduras Aguan"],
        "AMALET": ["Balfate", "Bonito Oriental"],
        "JORGE": ["Planes", "Jutiapa", "Sonaguera", "Faust"]
    };

    // INICIO
    window.onload = function() {
        document.getElementById('fecha').valueAsDate = new Date();
        llenarZonas();
        actualizarCuentas();
        
        // Cargar Dep√≥sitos
        db.ref('registros_milagro').on('value', snap => {
            listaDep = [];
            if(snap.val()) Object.keys(snap.val()).forEach(k => listaDep.push({id:k, ...snap.val()[k]}));
            actualizarTabla();
        });

        // Cargar Contado (NUEVA CARPETA)
        db.ref('ventas_contado').on('value', snap => {
            listaCon = [];
            if(snap.val()) Object.keys(snap.val()).forEach(k => listaCon.push({id:k, ...snap.val()[k]}));
            actualizarTabla();
        });
    }

    // --- CAMBIAR PESTA√ëA ---
    window.cambiarPestana = function(modo) {
        MODO = modo;
        cancelar(); // Limpiar form

        // Reset clases
        document.getElementById('tab-oficina').className = 'tab';
        document.getElementById('tab-campo').className = 'tab';
        document.getElementById('tab-contado').className = 'tab';
        
        // Activar la correcta
        const btn = document.getElementById('btn-guardar');
        const tit = document.getElementById('titulo-form');
        
        if(modo === 'OFICINA') {
            document.getElementById('tab-oficina').className = 'tab active-oficina';
            mostrarSeccion('DEPOSITOS');
            btn.className = 'btn-verde'; btn.innerText = "GUARDAR (OFICINA)";
            tit.innerText = "INGRESO DE OFICINA";
            tit.style.color = "#004d40";
        } 
        else if(modo === 'CAMPO') {
            document.getElementById('tab-campo').className = 'tab active-campo';
            mostrarSeccion('DEPOSITOS');
            btn.className = 'btn-naranja'; btn.innerText = "GUARDAR (CAMPO)";
            tit.innerText = "INGRESO DE CAMPO";
            tit.style.color = "#e65100";
        } 
        else { // CONTADO
            document.getElementById('tab-contado').className = 'tab active-contado';
            mostrarSeccion('CONTADO');
            btn.className = 'btn-morado'; btn.innerText = "GUARDAR VENTA CONTADO";
            tit.innerText = "REGISTRO DE VENTA CONTADO";
            tit.style.color = "#6200ea";
        }
        
        actualizarCuentas();
        actualizarTabla();
    }

    function mostrarSeccion(tipo) {
        if(tipo === 'DEPOSITOS') {
            document.getElementById('seccion-depositos').style.display = 'block';
            document.getElementById('seccion-contado').style.display = 'none';
            document.getElementById('lbl-monto').innerText = "Monto Dep√≥sito (L.):";
        } else {
            document.getElementById('seccion-depositos').style.display = 'none';
            document.getElementById('seccion-contado').style.display = 'block';
            document.getElementById('lbl-monto').innerText = "Saldo Contado (L.):";
        }
    }

    // --- GUARDAR ---
    window.guardar = function() {
        const fecha = document.getElementById('fecha').value;
        const monto = parseFloat(document.getElementById('monto').value);
        
        if(isNaN(monto)) { alert("Falta el monto"); return; }

        let rutaFirebase = '';
        let datos = {};

        if(MODO === 'CONTADO') {
            const vend = document.getElementById('vendedor_contado').value;
            const art = document.getElementById('articulo').value;
            if(!vend || !art) { alert("Faltan datos de vendedor o art√≠culo"); return; }
            
            rutaFirebase = 'ventas_contado';
            datos = { fecha, vendedor: vend, articulo: art, monto };
        } else {
            const sem = document.getElementById('semana').value;
            const ref = document.getElementById('referencia').value;
            const zon = document.getElementById('zona').value;
            const cob = document.getElementById('cobrador').value;
            const cue = document.getElementById('cuenta').value;
            
            if(!zon || !ref) { alert("Faltan datos de zona o referencia"); return; }
            
            rutaFirebase = 'registros_milagro';
            datos = { origen: MODO, semana: sem, fecha, ref, zona: zon, cobrador: cob, cuenta: cue, monto };
        }

        if(ID_EDITANDO) {
            db.ref(rutaFirebase + '/' + ID_EDITANDO).update(datos).then(() => { alert("Actualizado"); cancelar(); });
        } else {
            db.ref(rutaFirebase).push(datos).then(() => { 
                document.getElementById('monto').value = "";
                document.getElementById('referencia').value = "";
                document.getElementById('articulo').value = "";
                alert("Guardado");
            });
        }
    }

    // --- TABLA ---
    function actualizarTabla() {
        const tbody = document.getElementById('tabla-body');
        const thead = document.getElementById('tabla-head');
        tbody.innerHTML = "";
        let total = 0;

        if(MODO === 'CONTADO') {
            thead.innerHTML = `<tr><th>Fecha</th><th>Vendedor</th><th>Art√≠culo</th><th>Monto</th><th>X</th></tr>`;
            
            listaCon.sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
            listaCon.forEach(r => {
                total += r.monto;
                tbody.innerHTML += `
                    <tr style="border-left: 4px solid #6200ea;">
                        <td>${r.fecha}</td>
                        <td><b>${r.vendedor}</b></td>
                        <td>${r.articulo}</td>
                        <td>L. ${r.monto}</td>
                        <td><button style="width:auto; padding:5px; margin:0; background:red;" onclick="borrar('${r.id}', 'CON')">üóëÔ∏è</button> <button style="width:auto; padding:5px; margin:0; background:blue;" onclick="editar('${r.id}', 'CON')">‚úèÔ∏è</button></td>
                    </tr>`;
            });
        } else {
            thead.innerHTML = `<tr><th>Orig</th><th>Fecha</th><th>Ref/Zona</th><th>Monto</th><th>X</th></tr>`;
            
            listaDep.sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
            listaDep.forEach(r => {
                total += r.monto;
                let color = r.origen === 'OFICINA' ? '#004d40' : '#e65100';
                tbody.innerHTML += `
                    <tr style="border-left: 4px solid ${color};">
                        <td>${r.origen.substring(0,3)}</td>
                        <td>${r.fecha}</td>
                        <td>${r.zona}<br><small>${r.ref}</small></td>
                        <td>L. ${r.monto}</td>
                        <td><button style="width:auto; padding:5px; margin:0; background:red;" onclick="borrar('${r.id}', 'DEP')">üóëÔ∏è</button> <button style="width:auto; padding:5px; margin:0; background:blue;" onclick="editar('${r.id}', 'DEP')">‚úèÔ∏è</button></td>
                    </tr>`;
            });
        }
        document.getElementById('total').innerText = "L. " + total.toLocaleString();
    }

    // --- BORRAR Y EDITAR ---
    window.borrar = function(id, tipo) {
        if(confirm("¬øEliminar?")) {
            let ruta = tipo === 'CON' ? 'ventas_contado' : 'registros_milagro';
            db.ref(ruta + '/' + id).remove();
        }
    }

    window.editar = function(id, tipo) {
        ID_EDITANDO = id;
        document.getElementById('btn-cancelar').style.display = 'inline-block';
        document.getElementById('btn-guardar').innerText = "ACTUALIZAR";
        window.scrollTo(0,0);

        if(tipo === 'CON') {
            let r = listaCon.find(x => x.id === id);
            document.getElementById('fecha').value = r.fecha;
            document.getElementById('vendedor_contado').value = r.vendedor;
            document.getElementById('articulo').value = r.articulo;
            document.getElementById('monto').value = r.monto;
        } else {
            let r = listaDep.find(x => x.id === id);
            document.getElementById('fecha').value = r.fecha;
            document.getElementById('semana').value = r.semana;
            document.getElementById('referencia').value = r.ref;
            document.getElementById('zona').value = r.zona;
            autoCobrador();
            document.getElementById('cuenta').value = r.cuenta;
            document.getElementById('monto').value = r.monto;
        }
    }

    window.cancelar = function() {
        ID_EDITANDO = null;
        document.getElementById('btn-cancelar').style.display = 'none';
        document.getElementById('monto').value = "";
        document.getElementById('articulo').value = "";
        document.getElementById('referencia').value = "";
        
        // Restaurar texto del boton
        if(MODO === 'CONTADO') document.getElementById('btn-guardar').innerText = "GUARDAR VENTA CONTADO";
        else document.getElementById('btn-guardar').innerText = "GUARDAR (" + MODO + ")";
    }

    // --- HELPER FUNCTIONS ---
    function llenarZonas() {
        const sel = document.getElementById('zona');
        for (const [cob, list] of Object.entries(rutas)) {
            const grp = document.createElement('optgroup'); grp.label = cob;
            list.forEach(z => {
                const op = document.createElement('option'); op.value = z; op.innerText = z; op.setAttribute('data-c', cob);
                grp.appendChild(op);
            });
            sel.appendChild(grp);
        }
    }
    
    window.autoCobrador = function() {
        const sel = document.getElementById('zona');
        document.getElementById('cobrador').value = sel.options[sel.selectedIndex].getAttribute('data-c') || "";
    }

    function actualizarCuentas() {
        const c = document.getElementById('cuenta');
        c.innerHTML = MODO === 'OFICINA' 
            ? "<option value='LESLY'>CUENTA LESLY</option>" 
            : "<option value='DAVID'>CUENTA DAVID</option><option value='DAVID_LESLY'>DAVID (VIA LESLY)</option><option value='JOSE_RODINDER'>JOSE RODINDER</option>";
    }

</script>
</body>
</html>
